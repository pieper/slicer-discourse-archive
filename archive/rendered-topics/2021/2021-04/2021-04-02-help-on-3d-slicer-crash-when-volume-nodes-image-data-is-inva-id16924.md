# Help on 3D Slicer crash when volume node's image data is invalid

**Topic ID**: 16924
**Date**: 2021-04-02
**URL**: https://discourse.slicer.org/t/help-on-3d-slicer-crash-when-volume-nodes-image-data-is-invalid/16924

---

## Post #1 by @jackxiong (2021-04-02 09:14 UTC)

<p>Hi Andras, I have tried on UnstructuredGridToVolume and refer to the code in below link: <a href="https://github.com/lassoan/SlicerNotebookDemos/blob/master/UnstructuredGridToVolume.ipynb" class="inline-onebox" rel="noopener nofollow ugc">SlicerNotebookDemos/UnstructuredGridToVolume.ipynb at master · lassoan/SlicerNotebookDemos · GitHub</a><br>
I believe the code is exactly the same except the input unstructuredGrid vtk file is generated by myself. Because in my case, I need convert ploydata to unstructuredGrid.</p>
<p>step 1: Generate the UnstructuredGrid vtk file in 3D Slicer python console, the code as blow:</p>
<pre><code class="lang-python">v = slicer.util.getNode('View1')
v.SetBoxVisible(False)

# Sphere
sphereSource = vtk.vtkSphereSource()
sphereSource.SetCenter(0,0,0)
sphereSource.SetRadius(5.0)
sphereSource.Update()
sphereSource = sphereSource.GetOutput() # vtkPolyData()

# Create a model with the sphere and add it to scene
modelNode = slicer.mrmlScene.AddNewNodeByClass('vtkMRMLModelNode')
modelNode.SetAndObservePolyData(sphereSource)
modelNode.CreateDefaultDisplayNodes()
modelNode.SetName('My sphere')

# Append the meshes
appendFilter = vtk.vtkAppendPolyData()
appendFilter.AddInputData(sphereSource)
appendFilter.Update()

ugrid = vtk.vtkUnstructuredGrid()
ugrid.DeepCopy(appendFilter.GetOutput())

writer = vtk.vtkUnstructuredGridWriter()
writer.SetFileTypeToASCII()
writer.SetFileName('unstructuredGrid.vtu')
writer.SetInputData(ugrid)
writer.Write()
</code></pre>
<p>after the above step, I got the generated unstructuredGrid file with the name ‘unstructuredGrid.vtu’</p>
<p>step 2: Use the generated UnstructuredGrid file as the input and converting it to volume. The code as below:</p>
<pre><code class="lang-python">import math
# Load sample unstructured grid

def calculate_dimensions(bounds, spacing):
    # compute dimensions
    dim = [0]*3
    for i in range(3):
        dim[i] = int(math.ceil((bounds[i * 2 + 1] - bounds[i * 2]) / spacing[i])) + 1
        if dim[i] &lt; 1:
            dim[i] = 1
    return dim

sampleModelFile = 'unstructuredGrid.vtu'
modelNode = slicer.util.loadModel(sampleModelFile)

# Set output volume properties
volumeNodeName = "MyNewVolume"
voxelType = vtk.VTK_FLOAT

# Create an empty output volume
bounds=[0,0,0,0,0,0]
modelNode.GetBounds(bounds)
spacing = [0]*3 # desired volume spacing
spacing[0] = 0.5
spacing[1] = 0.5
spacing[2] = 0.5

imageSize = calculate_dimensions(bounds, spacing)
imageOrigin = [bounds[0], bounds[2], bounds[4]]
imageSpacing = [(bounds[1]-bounds[0])/imageSize[0], (bounds[3]-bounds[2])/imageSize[1], (bounds[5]-bounds[4])/imageSize[2]]
imageDirections = [[1,0,0], [0,1,0], [0,0,1]]
imageData = vtk.vtkImageData()

imageData.SetDimensions(imageSize)
imageData.AllocateScalars(voxelType, 1)
# Create volume node
volumeNode = slicer.mrmlScene.AddNewNodeByClass("vtkMRMLScalarVolumeNode", volumeNodeName)
volumeNode.SetOrigin(imageOrigin)
volumeNode.SetSpacing(imageSpacing)
volumeNode.SetIJKToRASDirections(imageDirections)
volumeNode.SetAndObserveImageData(imageData)
volumeNode.CreateDefaultDisplayNodes()

# Sample the mesh at each voxel of the image volume

# Set up matrices to put model points into ijk space of volume
# This assumes points are in RAS space of volume (i.e. RAS==world)
transformer = vtk.vtkTransformFilter()
transformer.SetInputConnection(modelNode.GetMeshConnection())
matrixRasToIjk = vtk.vtkMatrix4x4()
volumeNode.GetRASToIJKMatrix(matrixRasToIjk)
transformRasToIjk = vtk.vtkTransform()
transformRasToIjk.SetMatrix(matrixRasToIjk)
transformer.SetTransform(transformRasToIjk)

probe = vtk.vtkProbeFilter()
probe.SetSourceConnection(transformer.GetOutputPort())
probe.SetInputConnection(volumeNode.GetImageDataConnection())
probe.Update()
volumeNode.SetAndObserveImageData(probe.GetOutput())

# Set colormap for volume display
volumeNode.GetDisplayNode().SetAndObserveColorNodeID(getNode('Inferno').GetID())
# Show all sides of the mesh
modelNode.GetDisplayNode().BackfaceCullingOff()
# Show volume in slice viewers
slicer.util.setSliceViewerLayers(background=volumeNode)
sliceLogics = slicer.app.layoutManager().mrmlSliceLogics()
for i in range(sliceLogics.GetNumberOfItems()):
    sliceLogics.GetItemAsObject(i).FitSliceToAll()
</code></pre>
<p>After step 2, 3D Slicer crashed without any prompt. And I cannot find any clue from the logs.<br>
is there any wrong with the code?  Thanks a lot for your great help!</p>

---

## Post #2 by @lassoan (2021-04-02 12:47 UTC)

<p>Polydata is a surface mesh, it is not an unstructured grid. Don’t attempt to write it using an unstructured grid writer. Slicer should not crash when you read an email invalid file, so I will fix that.</p>
<p>You can convert polydata to volume using segmentation.</p>
<p>See example of creating segment from sphere source <a href="https://www.slicer.org/wiki/Documentation/Nightly/ScriptRepository#Get_histogram_of_a_segmented_region">here</a>. Around there you can find examples that show how to export segmentation to volume.</p>

---

## Post #3 by @jackxiong (2021-04-02 13:19 UTC)

<p>Thank you so much for the quick reply! I will try it.</p>

---

## Post #4 by @lassoan (2021-04-03 00:51 UTC)

<aside class="quote no-group" data-username="lassoan" data-post="2" data-topic="16924">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/lassoan/48/13_2.png" class="avatar"> lassoan:</div>
<blockquote>
<p>Slicer should not crash when you read an email invalid file, so I will fix that.</p>
</blockquote>
</aside>
<p>I’ve checked and latest Slicer Stable and Preview Releases properly report that the file is invalid and do not crash. Can you reproduce the crash with a latest release? If you execute the code line by line, which line causes the crash?</p>

---

## Post #5 by @jackxiong (2021-04-03 01:37 UTC)

<p>Yes, it is crashed on both 4.11 and 4.13 version, I don’t know if the version 4.13 is the latest one, it is a build version serveral weeks ago. After step 2, I have copied the code line by line in 3D Slicer python console, when execute the below line:</p>
<h1>Show volume in slice viewers</h1>
<p><strong>slicer.util.setSliceViewerLayers(background=volumeNode)</strong></p>
<p>The 3D Slicer crashed and quit.  I have also tried the version 4.13 in Visual Studio 2019 debug mode. And it reported exception:</p>
<p>in  vtkReslicePermuteExecute  captured <strong>scalar is nullptr</strong>.</p>
<p>If anything needed please feel free to tell me.</p>
<p>Thanks a lot for your help!</p>

---

## Post #6 by @lassoan (2021-04-03 03:30 UTC)

<p>I see. I don’t think there is a chance we can capture such low level errors. You can always find execution paths that are not protected from invalid inputs. In this case the volume node’s input is invalid in a very strange way. Using the volume node’s image data both as input and output of vtkProbeFilter does not look good; and due to the not loaded model, the probe filter’s source connection contains invalid input, too.</p>

---

## Post #7 by @jackxiong (2021-04-03 06:23 UTC)

<p>OK. I got it. Thank you!</p>

---
