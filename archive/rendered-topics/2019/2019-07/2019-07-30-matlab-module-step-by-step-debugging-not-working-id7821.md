---
topic_id: 7821
title: "Matlab Module Step By Step Debugging Not Working"
date: 2019-07-30
url: https://discourse.slicer.org/t/7821
---

# Matlab Module step-by-step debugging not working

**Topic ID**: 7821
**Date**: 2019-07-30
**URL**: https://discourse.slicer.org/t/matlab-module-step-by-step-debugging-not-working/7821

---

## Post #1 by @Prashant_Pandey (2019-07-30 22:14 UTC)

<p>Using Windows 10, Slicer 4.10.2, MATLAB 2018a</p>
<p>Expected behavior: Custom Matlab module execution stops at breakpoint<br>
What happens: Module execution is not affected by breakpoints</p>
<p>I read the instructions here <a href="https://www.slicer.org/wiki/Documentation/Nightly/Extensions/MatlabBridge" rel="nofollow noopener">https://www.slicer.org/wiki/Documentation/Nightly/Extensions/MatlabBridge</a> for ‘step-by-step’ debugging, but when I run my module from Slicer a connection cli_commandserver is made and the module finishes execution without stopping at the breakpoints, and then the connection is closed.</p>
<p>I also can’t seem to edit my Matlab functions or scripts (not the .xml file) and see changes in Slicer instantly, I always have to restart slicer to notice any changes. This seems different from the behaviour in this video: <a href="https://www.youtube.com/watch?v=8LijOcv3GDY&amp;feature=youtu.be" rel="nofollow noopener">https://www.youtube.com/watch?v=8LijOcv3GDY&amp;feature=youtu.be</a></p>
<p>Thanks!</p>

---

## Post #2 by @Prashant_Pandey (2019-07-30 23:37 UTC)

<p>Okay I fixed it, turns out I was adding breakpoints to files in the incorrect  folder!</p>
<p>However I’ve run into two new problems:<br>
My matlab module takes two directory paths as inputs. At the moment I am defining them as ‘strings’ within the .xml file. However when I’m reading them in the matlab function with inputParams.stringName I only receive an escape character instead of the full string, which I defined as something like “C:/Users/slicer-module-test/”</p>
<p>Second issue:<br>
Even though my matlab module does not take an image as input, it outputs 2 images. These images are generated by some matlab function which are processing .mha files saved in a separate directory.<br>
However, I can’t seem to correctly read the output volumes in my matlab module function.<br>
I’m using<br>
<code>cli_imageread(inputParams.outputvol1)</code><br>
to read the file, but this returns an error because inputParams.outputvol1 refers to a nonexistent the path to a vtkMRMLScalarVolumeNode.nrrd file. Is this because it is an empty scalar volume node that I create in Slicer before running module?</p>
<p>My full code is:</p>
<pre><code>function outputParams=USSegmentAndReconstruct(inputParams)

clc
cd(userpath)
startup %this adds relevant directories to my path

num_files = inputParams.num_files;      %input integer
data_dir = inputParams.data_dir;           %input directory string
config_fname = inputParams.config_fname;        %input directory string

combinedVol = cli_imageread(inputParams.combinedVol);      %output volume1 (I get an error here)
US_dist = cli_imageread(inputParams.US_dist);                      %output volume2

[combinedVol.pixelData, US_dist.pixelData] = someImageProcessing(num_files, data_dir, config_fname);

cli_imagewrite(inputParams.combinedVol, combinedVol);
cli_imagewrite(inputParams.US_dist, US_dist);
</code></pre>
<p>I can’t quite figure out what I am doing wrong here, but I guess it has something to do with the fact that both <code>inputParams.combinedVol</code> and <code>inputParams.US_dist</code> do not contain any data… yet</p>

---

## Post #3 by @lassoan (2019-07-31 12:52 UTC)

<aside class="quote no-group" data-username="Prashant_Pandey" data-post="2" data-topic="7821">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/c0e974/48.png" class="avatar"> Prashant_Pandey:</div>
<blockquote>
<p>I only receive an escape character instead</p>
</blockquote>
</aside>
<p>What escape character do you get? Can you pass a simple string that does not contain spaces, slashes, and quotes?</p>
<aside class="quote no-group" data-username="Prashant_Pandey" data-post="2" data-topic="7821">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/c0e974/48.png" class="avatar"> Prashant_Pandey:</div>
<blockquote>
<p>which are processing .mha files saved in a separate directory</p>
</blockquote>
</aside>
<p>You need to create image files by the names that Slicer provides. If you must create .mha file then change the module descriptor xml file so that Slicer generates a file with .mha extension.</p>
<aside class="quote no-group" data-username="Prashant_Pandey" data-post="2" data-topic="7821">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/c0e974/48.png" class="avatar"> Prashant_Pandey:</div>
<blockquote>
<p>I can’t quite figure out what I am doing wrong here</p>
</blockquote>
</aside>
<p>One issue for sure is that you use <code>inputParams.combinedVol</code> and <code>inputParams.US_dist</code> both as input and output volumes. If they are output volumes then don’t call cli_imageread on them because they don’t exist (you have to create them).</p>

---

## Post #4 by @Prashant_Pandey (2019-07-31 17:19 UTC)

<p>The escape character was: <code>\</code><br>
I no longer have that issue after removing “quotation marks” and using <code>&lt;directory&gt;</code> tags instead of <code>&lt;string&gt;</code> tags in the .xml file.</p>
<aside class="quote no-group" data-username="lassoan" data-post="3" data-topic="7821">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/lassoan/48/13_2.png" class="avatar"> lassoan:</div>
<blockquote>
<p>If they are output volumes then don’t call cli_imageread on them because they don’t exist (you have to create them).</p>
</blockquote>
</aside>
<p>I don’t quite understand how to do this. How do I create an empty .mha image which I can write to through the matlab function, and how is it supposed to be defined in the .xml file?</p>

---

## Post #5 by @lassoan (2019-07-31 18:59 UTC)

<aside class="quote no-group" data-username="Prashant_Pandey" data-post="4" data-topic="7821">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/c0e974/48.png" class="avatar"> Prashant_Pandey:</div>
<blockquote>
<p>How do I create an empty .mha image</p>
</blockquote>
</aside>
<p>I don’t know how you create .mha image from scratch (I’m sure there are .mha writer matlab scripts). I would recommend using the .nrrd reader and writer scripts that are bundled with the MatlabBridge. They are tested to work well with Slicer. Here are examples of how to create .nrrd image file from scratch:</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/PerkLab/SlicerMatlabBridge/blob/934a1eff4db11b16af7d3de31357d08515dd05cd/MatlabCommander/commandserver/nrrdwrite.m#L30-L49">
  <header class="source">

      <a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/934a1eff4db11b16af7d3de31357d08515dd05cd/MatlabCommander/commandserver/nrrdwrite.m#L30-L49" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/934a1eff4db11b16af7d3de31357d08515dd05cd/MatlabCommander/commandserver/nrrdwrite.m#L30-L49" target="_blank" rel="noopener">PerkLab/SlicerMatlabBridge/blob/934a1eff4db11b16af7d3de31357d08515dd05cd/MatlabCommander/commandserver/nrrdwrite.m#L30-L49</a></h4>



    <pre class="onebox"><code class="lang-m">
      <ol class="start lines" start="30" style="counter-reset: li-counter 29 ;">
          <li>% 2. Creating volume from scratch - minimal example
</li>
          <li>%
</li>
          <li>%   [x,y,z] = meshgrid([-10:10],[-12:15],[-8:6]);
</li>
          <li>%   img.pixelData = x/3+y/4+z/2;
</li>
          <li>%
</li>
          <li>%   nrrdwrite('testOutput.nrrd', img);
</li>
          <li>%  
</li>
          <li>% 3. Creating volume from scratch
</li>
          <li>%
</li>
          <li>%   % Set pixel data
</li>
          <li>%   [x,y,z] = meshgrid([-10:10],[-12:15],[-8:6]);
</li>
          <li>%   img.pixelData = x/3+y/4+z/2;
</li>
          <li>%
</li>
          <li>%   % Define origin, spacing, axis directions by a homogeneous transformation matrix:
</li>
          <li>%   img.ijkToLpsTransform = [ 1.2 0 0 10; 0 1.2 0 12; 0 0 3.0 -22; 0 0 0 1];
</li>
          <li>%
</li>
          <li>%   % Enable compression
</li>
          <li>%   img.metaData.encoding='gzip';
</li>
          <li>%
</li>
          <li>%   nrrdwrite('testOutput.nrrd', img);
</li>
      </ol>
    </code></pre>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>


---

## Post #6 by @Prashant_Pandey (2019-07-31 20:55 UTC)

<p>Thanks Andras, I understand now and got it to work.</p>
<p>For reference, I’ve been using mha_read_volume.m, mha_read_header.m, and mha_write_volume.m Matlab functions from <a href="https://github.com/PlusToolkit/PlusMatlabUtils/tree/master/MatlabMetafileIO" rel="nofollow noopener">https://github.com/PlusToolkit/PlusMatlabUtils/tree/master/MatlabMetafileIO</a> to read and write .mha volumes.</p>
<p>However since MHA files are not one-indexed (and in my case are in RAI coordinate system), I had to write the img.ijkToLpsTransform like this:</p>
<pre><code>outputVolume.ijkToLpsTransform = [info.PixelDimensions(1), 0, 0, info.Offset(1)-info.PixelDimensions(1); ...
    0, info.PixelDimensions(2), 0, info.Offset(2)-info.PixelDimensions(2); ...
    0, 0, info.PixelDimensions(3), info.Offset(3)-info.PixelDimensions(3); ...
    0, 0, 0, 1];
</code></pre>
<p>Where <code>info</code> is the header information output/input for mha_read_header/mha_write_volume.m</p>

---

## Post #7 by @lassoan (2019-08-01 04:00 UTC)

<p>Thanks for the update.</p>
<p>Note that <code>AnatomicalOrientation = RAI</code> in a metaimage file means that coordinates are defined in LPS coordinate coordinate system. Slicer uses LPS coordinate system for files but otherwise uses RAS coordinates.</p>
<p>Indeed, you need to pay attention to Matlab’s unconventional 1-based array indexing. The nrrd reader/writer class bundled with MatlabBridge extension takes care of this as shown <a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/934a1eff4db11b16af7d3de31357d08515dd05cd/MatlabCommander/commandserver/nrrdwrite.m#L84-L86" rel="nofollow noopener">here</a>.</p>

---
