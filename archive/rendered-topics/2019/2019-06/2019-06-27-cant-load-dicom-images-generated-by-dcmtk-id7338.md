# Can't load dicom images generated by dcmtk

**Topic ID**: 7338
**Date**: 2019-06-27
**URL**: https://discourse.slicer.org/t/cant-load-dicom-images-generated-by-dcmtk/7338

---

## Post #1 by @pdeman (2019-06-27 12:00 UTC)

<p>Hi,<br>
I have generated few dicom using dcmtk. I can open them using some software (imagej, xnview etc …).<br>
dcm2pnm test0004.dcm test.bmp works perfectly, as well as dcmdump G:\Contracts\Novartis\test0004.dcm<br>
so the dicom file must not be far from something “good”.<br>
output of dcmdump:</p>
<details>
<summary>
DICOM tags</summary>
<pre><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: Little Endian Explicit
(0002,0000) UL 198                                      #   4, 1 FileMetaInformationGroupLength
(0002,0001) OB 00\01                                    #   2, 1 FileMetaInformationVersion
(0002,0002) UI [1.2.276.0.7230010.3.1.0.1]              #  26, 1 MediaStorageSOPClassUID
(0002,0003) UI [1.2.276.0.7230010.3.1.4.613533732.15860.1561626548.497] #  54, 1 MediaStorageSOPInstanceUID
(0002,0010) UI =LittleEndianExplicit                    #  20, 1 TransferSyntaxUID
(0002,0012) UI [1.2.276.0.7230010.3.0.3.6.4]            #  28, 1 ImplementationClassUID
(0002,0013) SH [OFFIS_DCMTK_364]                        #  16, 1 ImplementationVersionName

# Dicom-Data-Set
# Used TransferSyntax: Little Endian Explicit
(0008,0005) CS [ISO_IR 100]                             #  10, 1 SpecificCharacterSet
(0008,0020) DA [20190627]                               #   8, 1 StudyDate
(0008,0021) DA [20190627]                               #   8, 1 SeriesDate
(0008,0022) DA [20190627]                               #   8, 1 AcquisitionDate
(0008,0023) DA [20190627]                               #   8, 1 ContentDate
(0008,0030) TM [110908.000]                             #  10, 1 StudyTime
(0008,0031) TM [110908.000]                             #  10, 1 SeriesTime
(0008,0032) TM [110908.000]                             #  10, 1 AcquisitionTime
(0008,0033) TM [110908.000]                             #  10, 1 ContentTime
(0008,0060) CS [OCT]                                    #   4, 1 Modality
(0008,0070) LO [Heidelberg Engineering]                 #  22, 1 Manufacturer
(0008,0090) PN (no value available)                     #   0, 0 ReferringPhysicianName
(0008,0221) CS [OCT]                                    #   4, 1 EquipmentModality
(0008,103e) LO [OCT]                                    #   4, 1 SeriesDescription
(0008,1070) PN [GYS]                                    #   4, 1 OperatorsName
(0008,1090) LO [Spectralis]                             #  10, 1 ManufacturerModelName
(0010,0020) LO [1.4.444.0.1.4.613533732.15860.1561626542.494] #  44, 1 PatientID
(0010,0040) CS [F]                                      #   2, 1 PatientSex
(0018,0050) DS [0.0598645833333333]                     #  18, 1 SliceThickness
(0020,000d) UI [1.4.444.0.1.2.613533732.15860.1561626542.495] #  44, 1 StudyInstanceUID
(0020,000e) UI [1.4.444.0.1.3.613533732.15860.1561626542.496] #  44, 1 SeriesInstanceUID
(0020,0010) SH [test]                                   #   4, 1 StudyID
(0020,0011) IS [0]                                      #   2, 1 SeriesNumber
(0020,0060) CS [OS]                                     #   2, 1 Laterality
(0020,1041) DS [0.0598645833333333]                     #  18, 1 SliceLocation
(0028,0002) US 1                                        #   2, 1 SamplesPerPixel
(0028,0004) CS [MONOCHROME2]                            #  12, 1 PhotometricInterpretation
(0028,0010) US 496                                      #   2, 1 Rows
(0028,0011) US 1024                                     #   2, 1 Columns
(0028,0030) DS [0.0057\0.0039]                          #  14, 2 PixelSpacing
(0028,0100) US 8                                        #   2, 1 BitsAllocated
(0028,0101) US 8                                        #   2, 1 BitsStored
(0028,0102) US 7                                        #   2, 1 HighBit
(0028,0103) US 0                                        #   2, 1 PixelRepresentation
(7fe0,0010) OB 00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00... # 507904, 1 PixelData
</code></pre>
</details>
<p>but I can not open them using Slicer. I give me this error:<br>
“Exception thrown in event: Calling methods on uninitialized ctkDICOMItem”</p>

---

## Post #2 by @Chris_Rorden (2019-06-27 12:44 UTC)

<p>Technically, this is not a valid DICOM image as it is missing Type 1 fields. Specifically, type 1 tags Image Orientation Patient (0020,0037), Image Position Patient (0020,0032). I suspect viewers that treat this as a simple bitmap may find this acceptable, but tools that want are interested in spatial position will find this underspecified.</p>

---

## Post #3 by @pdeman (2019-06-27 13:02 UTC)

<p>thanks for the answer, I was suspecting something like that, even if in eye oct ( Ophthalmic Optical Coherence Tomography B-scan Volume Analysis CIOD : <a href="https://dicom.innolitics.com/ciods/ophthalmic-optical-coherence-tomography-b-scan-volume-analysis" rel="nofollow noopener">https://dicom.innolitics.com/ciods/ophthalmic-optical-coherence-tomography-b-scan-volume-analysis</a>) it does not make much sens, they are not even in the list of fields for this type of images on this website. I will try to add these fields with “random values”</p>

---

## Post #4 by @pdeman (2019-06-27 13:57 UTC)

<p>I see that the frame of reference is “requested” as well but don’t get what it refers to. I have some ct scan, for which there is an uid in this field 0020,0052 but the uid in it doesn’t match with any uid in the studies.</p>

---

## Post #5 by @lassoan (2019-06-27 14:14 UTC)

<p>If OCT images do not require these fields then the proper solution would be to add a DICOM plugin to handle these volumes. You can write a DICOM import plugin by cloning an existing plugin and customizing it. See for example scalar volume importer plugin <a href="https://github.com/Slicer/Slicer/blob/master/Modules/Scripted/DICOMPlugins/DICOMScalarVolumePlugin.py" rel="nofollow noopener">here</a> and some ultrasound importer plugins <a href="https://github.com/SlicerHeart/SlicerHeart/blob/master/DicomUltrasoundPlugin/DicomUltrasoundPlugin.py" rel="nofollow noopener">here</a>.</p>
<p>You may also use DICOM Patcher module to add image plane fields (image position patient, image orientation patient, etc.).</p>

---

## Post #6 by @fedorov (2019-06-27 17:50 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="4" data-topic="7338" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>I see that the frame of reference is “requested” as well but don’t get what it refers to. I have some ct scan, for which there is an uid in this field 0020,0052 but the uid in it doesn’t match with any uid in the studies.</p>
</blockquote>
</aside>
<p>Frame of reference UID is usually the same across series in a study. But I am sure there can be exceptions, and in any case Slicer is not using it, so if you don’t have it, it’s not a problem for loading images into Slicer.</p>

---

## Post #7 by @pdeman (2019-06-28 07:28 UTC)

<p>thanks. I have added an empty value just in case</p>

---

## Post #8 by @pdeman (2019-06-28 07:38 UTC)

<p>thanks to you, I have added the missing field an now it loads the dicom but not correctly.<br>
<img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/1/e/1ec57911a4766ca5c0a102ccef078b82d06b6665.png" alt="SlicerError3" data-base62-sha1="4odphZbvcbxHBdwtneuhdgAQzTD" width="190" height="157"><br>
it sees there is 97 dicom files and load all of them.<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/9/2/92b27b4fe5c032d01e98a14561de735104bd532b.png" data-download-href="/uploads/short-url/kVK6ze3xQPc3vglIFqe6CQ0akK7.png?dl=1" title="Slicer" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/2/92b27b4fe5c032d01e98a14561de735104bd532b_2_690x358.png" alt="Slicer" data-base62-sha1="kVK6ze3xQPc3vglIFqe6CQ0akK7" width="690" height="358" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/2/92b27b4fe5c032d01e98a14561de735104bd532b_2_690x358.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/2/92b27b4fe5c032d01e98a14561de735104bd532b_2_1035x537.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/2/92b27b4fe5c032d01e98a14561de735104bd532b_2_1380x716.png 2x" data-dominant-color="E5E9ED"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Slicer</span><span class="informations">1902×987 113 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/4/b/4b97efb2748785226dd4b78720f08755ee36154f.png" data-download-href="/uploads/short-url/aMJkBwaXCFBuFmtDo4lwf4gdmJV.png?dl=1" title="SlicerError2" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/4/b/4b97efb2748785226dd4b78720f08755ee36154f_2_690x355.png" alt="SlicerError2" data-base62-sha1="aMJkBwaXCFBuFmtDo4lwf4gdmJV" width="690" height="355" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/4/b/4b97efb2748785226dd4b78720f08755ee36154f_2_690x355.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/4/b/4b97efb2748785226dd4b78720f08755ee36154f.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/4/b/4b97efb2748785226dd4b78720f08755ee36154f.png 2x" data-dominant-color="353130"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">SlicerError2</span><span class="informations">705×363 120 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div><br>
all slices have the same image.<br>
and normally on the “view metadata interface”, there is the possibility to navigate between instance of the same series with a slider, which I don’t have.<br>
(I have checked using dcm2pnm the image is different each time, the problem doesn’t come from there).</p>
<p>here are 3 dcmdump as example.<br>
the image position and instance number change for each “slice”. so I don’t get why it displays always the same slice.</p>
<details>
<summary>
test0030.dcm</summary>
<pre><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: Little Endian Explicit
(0002,0000) UL 186                                      #   4, 1 FileMetaInformationGroupLength
(0002,0001) OB 00\01                                    #   2, 1 FileMetaInformationVersion
(0002,0002) UI =SecondaryCaptureImageStorage            #  26, 1 MediaStorageSOPClassUID
(0002,0003) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 MediaStorageSOPInstanceUID
(0002,0010) UI =LittleEndianExplicit                    #  20, 1 TransferSyntaxUID
(0002,0012) UI [1.2.276.0.7230010.3.0.3.6.4]            #  28, 1 ImplementationClassUID
(0002,0013) SH [OFFIS_DCMTK_364]                        #  16, 1 ImplementationVersionName

# Dicom-Data-Set
# Used TransferSyntax: Little Endian Explicit
(0008,0005) CS [ISO_IR 100]                             #  10, 1 SpecificCharacterSet
(0008,0016) UI =SecondaryCaptureImageStorage            #  26, 1 SOPClassUID
(0008,0018) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 SOPInstanceUID
(0008,0020) DA [20190628]                               #   8, 1 StudyDate
(0008,0021) DA [20190628]                               #   8, 1 SeriesDate
(0008,0022) DA [20190628]                               #   8, 1 AcquisitionDate
(0008,0023) DA [20190628]                               #   8, 1 ContentDate
(0008,0030) TM [092450.000]                             #  10, 1 StudyTime
(0008,0031) TM [092450.000]                             #  10, 1 SeriesTime
(0008,0032) TM [092450.000]                             #  10, 1 AcquisitionTime
(0008,0033) TM [092450.000]                             #  10, 1 ContentTime
(0008,0050) SH (no value available)                     #   0, 0 AccessionNumber
(0008,0060) CS [OCT]                                    #   4, 1 Modality
(0008,0070) LO [Heidelberg Engineering]                 #  22, 1 Manufacturer
(0008,0090) PN (no value available)                     #   0, 0 ReferringPhysicianName
(0008,0221) CS [OCT]                                    #   4, 1 EquipmentModality
(0008,103e) LO [OCT]                                    #   4, 1 SeriesDescription
(0008,1070) PN [GYS]                                    #   4, 1 OperatorsName
(0008,1090) LO [Spectralis]                             #  10, 1 ManufacturerModelName
(0010,0010) PN (no value available)                     #   0, 0 PatientName
(0010,0020) LO [1.4.444.0.1.4.613533732.156.1561706684.738] #  42, 1 PatientID
(0010,0040) CS [F]                                      #   2, 1 PatientSex
(0010,1010) AS (no value available)                     #   0, 0 PatientAge
(0018,0050) DS [0.0598645833333333]                     #  18, 1 SliceThickness
(0018,5100) CS [HFP]                                    #   4, 1 PatientPosition
(0020,000d) UI [1.4.444.0.1.2.613533732.156.1561706684.740] #  42, 1 StudyInstanceUID
(0020,000e) UI [1.4.444.0.1.3.613533732.156.1561706684.741] #  42, 1 SeriesInstanceUID
(0020,0010) SH [test]                                   #   4, 1 StudyID
(0020,0011) IS [1]                                      #   2, 1 SeriesNumber
(0020,0013) IS [31]                                     #   2, 1 InstanceNumber
(0020,0032) DS [0\0\1.85580208333333]                   #  20, 3 ImagePositionPatient
(0020,0037) DS [1\0\0\0\1\0]                            #  12, 6 ImageOrientationPatient
(0020,0060) CS [L]                                      #   2, 1 Laterality
(0020,1041) DS [1.85580208333333]                       #  16, 1 SliceLocation
(0028,0002) US 1                                        #   2, 1 SamplesPerPixel
(0028,0004) CS [MONOCHROME2]                            #  12, 1 PhotometricInterpretation
(0028,0010) US 496                                      #   2, 1 Rows
(0028,0011) US 1024                                     #   2, 1 Columns
(0028,0030) DS [0.0057\0.0039]                          #  14, 2 PixelSpacing
(0028,0100) US 8                                        #   2, 1 BitsAllocated
(0028,0101) US 8                                        #   2, 1 BitsStored
(0028,0102) US 7                                        #   2, 1 HighBit
(0028,0103) US 0                                        #   2, 1 PixelRepresentation
(7fe0,0010) OB 00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00... # 507904, 1 PixelData
</code></pre>
</details>
<details>
<summary>
test0010.dcm</summary>
<pre><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: Little Endian Explicit
(0002,0000) UL 186                                      #   4, 1 FileMetaInformationGroupLength
(0002,0001) OB 00\01                                    #   2, 1 FileMetaInformationVersion
(0002,0002) UI =SecondaryCaptureImageStorage            #  26, 1 MediaStorageSOPClassUID
(0002,0003) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 MediaStorageSOPInstanceUID
(0002,0010) UI =LittleEndianExplicit                    #  20, 1 TransferSyntaxUID
(0002,0012) UI [1.2.276.0.7230010.3.0.3.6.4]            #  28, 1 ImplementationClassUID
(0002,0013) SH [OFFIS_DCMTK_364]                        #  16, 1 ImplementationVersionName

# Dicom-Data-Set
# Used TransferSyntax: Little Endian Explicit
(0008,0005) CS [ISO_IR 100]                             #  10, 1 SpecificCharacterSet
(0008,0016) UI =SecondaryCaptureImageStorage            #  26, 1 SOPClassUID
(0008,0018) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 SOPInstanceUID
(0008,0020) DA [20190628]                               #   8, 1 StudyDate
(0008,0021) DA [20190628]                               #   8, 1 SeriesDate
(0008,0022) DA [20190628]                               #   8, 1 AcquisitionDate
(0008,0023) DA [20190628]                               #   8, 1 ContentDate
(0008,0030) TM [092450.000]                             #  10, 1 StudyTime
(0008,0031) TM [092450.000]                             #  10, 1 SeriesTime
(0008,0032) TM [092450.000]                             #  10, 1 AcquisitionTime
(0008,0033) TM [092450.000]                             #  10, 1 ContentTime
(0008,0050) SH (no value available)                     #   0, 0 AccessionNumber
(0008,0060) CS [OCT]                                    #   4, 1 Modality
(0008,0070) LO [Heidelberg Engineering]                 #  22, 1 Manufacturer
(0008,0090) PN (no value available)                     #   0, 0 ReferringPhysicianName
(0008,0221) CS [OCT]                                    #   4, 1 EquipmentModality
(0008,103e) LO [OCT]                                    #   4, 1 SeriesDescription
(0008,1070) PN [GYS]                                    #   4, 1 OperatorsName
(0008,1090) LO [Spectralis]                             #  10, 1 ManufacturerModelName
(0010,0010) PN (no value available)                     #   0, 0 PatientName
(0010,0020) LO [1.4.444.0.1.4.613533732.156.1561706684.738] #  42, 1 PatientID
(0010,0040) CS [F]                                      #   2, 1 PatientSex
(0010,1010) AS (no value available)                     #   0, 0 PatientAge
(0018,0050) DS [0.0598645833333333]                     #  18, 1 SliceThickness
(0018,5100) CS [HFP]                                    #   4, 1 PatientPosition
(0020,000d) UI [1.4.444.0.1.2.613533732.156.1561706684.740] #  42, 1 StudyInstanceUID
(0020,000e) UI [1.4.444.0.1.3.613533732.156.1561706684.741] #  42, 1 SeriesInstanceUID
(0020,0010) SH [test]                                   #   4, 1 StudyID
(0020,0011) IS [1]                                      #   2, 1 SeriesNumber
(0020,0013) IS [11]                                     #   2, 1 InstanceNumber
(0020,0032) DS [0\0\0.658510416666667]                  #  22, 3 ImagePositionPatient
(0020,0037) DS [1\0\0\0\1\0]                            #  12, 6 ImageOrientationPatient
(0020,0060) CS [L]                                      #   2, 1 Laterality
(0020,1041) DS [0.658510416666667]                      #  18, 1 SliceLocation
(0028,0002) US 1                                        #   2, 1 SamplesPerPixel
(0028,0004) CS [MONOCHROME2]                            #  12, 1 PhotometricInterpretation
(0028,0010) US 496                                      #   2, 1 Rows
(0028,0011) US 1024                                     #   2, 1 Columns
(0028,0030) DS [0.0057\0.0039]                          #  14, 2 PixelSpacing
(0028,0100) US 8                                        #   2, 1 BitsAllocated
(0028,0101) US 8                                        #   2, 1 BitsStored
(0028,0102) US 7                                        #   2, 1 HighBit
(0028,0103) US 0                                        #   2, 1 PixelRepresentation
(7fe0,0010) OB 00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00... # 507904, 1 PixelData
</code></pre>
</details>
<details>
<summary>
test0020.dcm</summary>
<pre><code># Dicom-File-Format

# Dicom-Meta-Information-Header
# Used TransferSyntax: Little Endian Explicit
(0002,0000) UL 186                                      #   4, 1 FileMetaInformationGroupLength
(0002,0001) OB 00\01                                    #   2, 1 FileMetaInformationVersion
(0002,0002) UI =SecondaryCaptureImageStorage            #  26, 1 MediaStorageSOPClassUID
(0002,0003) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 MediaStorageSOPInstanceUID
(0002,0010) UI =LittleEndianExplicit                    #  20, 1 TransferSyntaxUID
(0002,0012) UI [1.2.276.0.7230010.3.0.3.6.4]            #  28, 1 ImplementationClassUID
(0002,0013) SH [OFFIS_DCMTK_364]                        #  16, 1 ImplementationVersionName

# Dicom-Data-Set
# Used TransferSyntax: Little Endian Explicit
(0008,0005) CS [ISO_IR 100]                             #  10, 1 SpecificCharacterSet
(0008,0016) UI =SecondaryCaptureImageStorage            #  26, 1 SOPClassUID
(0008,0018) UI [1.4.444.0.1.4.613533732.156.1561706684.739] #  42, 1 SOPInstanceUID
(0008,0020) DA [20190628]                               #   8, 1 StudyDate
(0008,0021) DA [20190628]                               #   8, 1 SeriesDate
(0008,0022) DA [20190628]                               #   8, 1 AcquisitionDate
(0008,0023) DA [20190628]                               #   8, 1 ContentDate
(0008,0030) TM [092450.000]                             #  10, 1 StudyTime
(0008,0031) TM [092450.000]                             #  10, 1 SeriesTime
(0008,0032) TM [092450.000]                             #  10, 1 AcquisitionTime
(0008,0033) TM [092450.000]                             #  10, 1 ContentTime
(0008,0050) SH (no value available)                     #   0, 0 AccessionNumber
(0008,0060) CS [OCT]                                    #   4, 1 Modality
(0008,0070) LO [Heidelberg Engineering]                 #  22, 1 Manufacturer
(0008,0090) PN (no value available)                     #   0, 0 ReferringPhysicianName
(0008,0221) CS [OCT]                                    #   4, 1 EquipmentModality
(0008,103e) LO [OCT]                                    #   4, 1 SeriesDescription
(0008,1070) PN [GYS]                                    #   4, 1 OperatorsName
(0008,1090) LO [Spectralis]                             #  10, 1 ManufacturerModelName
(0010,0010) PN (no value available)                     #   0, 0 PatientName
(0010,0020) LO [1.4.444.0.1.4.613533732.156.1561706684.738] #  42, 1 PatientID
(0010,0040) CS [F]                                      #   2, 1 PatientSex
(0010,1010) AS (no value available)                     #   0, 0 PatientAge
(0018,0050) DS [0.0598645833333333]                     #  18, 1 SliceThickness
(0018,5100) CS [HFP]                                    #   4, 1 PatientPosition
(0020,000d) UI [1.4.444.0.1.2.613533732.156.1561706684.740] #  42, 1 StudyInstanceUID
(0020,000e) UI [1.4.444.0.1.3.613533732.156.1561706684.741] #  42, 1 SeriesInstanceUID
(0020,0010) SH [test]                                   #   4, 1 StudyID
(0020,0011) IS [1]                                      #   2, 1 SeriesNumber
**(0020,0013) IS [21]                                     #   2, 1 InstanceNumber**
**(0020,0032) DS [0\0\1.25715625]                         #  14, 3 ImagePositionPatient**
**(0020,0037) DS [1\0\0\0\1\0]                            #  12, 6 ImageOrientationPatient**
(0020,0060) CS [L]                                      #   2, 1 Laterality
(0020,1041) DS [1.25715625]                             #  10, 1 SliceLocation
(0028,0002) US 1                                        #   2, 1 SamplesPerPixel
(0028,0004) CS [MONOCHROME2]                            #  12, 1 PhotometricInterpretation
(0028,0010) US 496                                      #   2, 1 Rows
(0028,0011) US 1024                                     #   2, 1 Columns
(0028,0030) DS [0.0057\0.0039]                          #  14, 2 PixelSpacing
(0028,0100) US 8                                        #   2, 1 BitsAllocated
(0028,0101) US 8                                        #   2, 1 BitsStored
(0028,0102) US 7                                        #   2, 1 HighBit
(0028,0103) US 0                                        #   2, 1 PixelRepresentation
(7fe0,0010) OB 00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00... # 507904, 1 PixelData
</code></pre>
</details>
<p>on the python console it shows this:</p>
<pre><code>Irregular volume geometry detected (maximum error of 1020.01 mm is above tolerance threshold of 0.001 mm).  Regularization transform is not added, as the option is disabled.
</code></pre>
<p>and apparently it uses the dicomscalarvolumplugin to open it.<br>
but I don’t know how to put breakpoint in it to see what happens.</p>

---

## Post #9 by @pdeman (2019-06-28 11:04 UTC)

<p>I just tried with adding a different acquisition time and content time for each slices, but I have got the same result. it shows only one slice, in the display and in the metadata viewer.</p>

---

## Post #10 by @pieper (2019-06-28 11:21 UTC)

<p><a class="mention" href="/u/pdeman">@pdeman</a> - it seems like a converter to make 3D volumes from your data could be a useful bit of code - would you be able to make it an open source tool along with some examples?  If so it would be a lot easier for us to help you debug.</p>

---

## Post #11 by @lassoan (2019-06-28 14:54 UTC)

<p>The metadata is still invalid, as the same SOP instance UID is reused in multiple files. This UID must be unique in each file.</p>
<p>You do not need to use different acquisition or content time. If you do, then you have the option of loading only group of frames that have the same acquisition or content time (if you enable “Allow loading subseries by time” in Application settings / DICOM).</p>

---

## Post #12 by @pdeman (2019-07-01 06:35 UTC)

<aside class="quote no-group" data-username="lassoan" data-post="11" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/lassoan/48/13_2.png" class="avatar"> lassoan:</div>
<blockquote>
<p>ent time. If you do, then you have the option of loading only group of fram</p>
</blockquote>
</aside>
<p>ok thanks, I did the correction and it works now. except that when I change slices, it says they are 1 mm spaced, instead of 0.059 mm</p>

---

## Post #13 by @lassoan (2019-07-01 12:41 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="12" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>it works now. except that when I change slices, it says they are 1 mm spaced, instead of 0.059 mm</p>
</blockquote>
</aside>
<p>Slice thickness field is not intended for defining geometry (such as distance between slices). Instead, slice spacing is defined by “image position patient” tag (position of next slice is obtained by incrementing previous slice position by slice spacing).</p>

---

## Post #14 by @pdeman (2019-09-11 13:31 UTC)

<p>I still have a problem with the geometry that I don’t get.<br>
the problem seems to come from:<br>
sliceCornersFromIJKToRAS in DICOMScalarVolumePlugin.py</p>
<blockquote>
<pre><code>  volumeNode.GetIJKToRASMatrix(ijkToRAS)
  print(ijkToRAS)
</code></pre>
</blockquote>
<p>return:</p>
<blockquote>
<p>Loading with imageIOName: GDCM<br>
vtkMatrix4x4 (000001FC74D84AD0)<br>
Debug: Off<br>
Modified Time: 323439<br>
Reference Count: 1<br>
Registered Events: (none)<br>
Elements:<br>
-1 0 0 0<br>
0 -1 0 0<br>
0 0 1 0<br>
0 0 0 1</p>
</blockquote>
<p>so the self.originalCorners are matrix in “pixel”<br>
while  self.targetCorners<br>
read from the dicom header in this python script are correct.</p>
<p>how the matrix GetIJKToRASMatrix is initialized ? why in my case it is incorrect ?</p>

---

## Post #15 by @lassoan (2019-09-11 13:44 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="14" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>I still have a problem with the geometry that I don’t get.</p>
</blockquote>
</aside>
<p>What is your problem? Image loaded but spacing is 1.0?</p>
<p>Are any error messages logged?</p>
<p>Could you send a sample data set?</p>

---

## Post #16 by @pdeman (2019-09-11 13:50 UTC)

<p>yes all spacing (in the 3 directions) is 1.0.<br>
I get a warning <img src="https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=15" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<blockquote>
<p>if maxError &gt; self.cornerEpsilon:<br>
warningText = “Irregular volume geometry detected (maximum error of %g mm is above tolerance threshold of %g mm).” % (maxError, self.cornerEpsilon)</p>
</blockquote>
<p>and maxError is high due to the fact that self.originalCorners does’nt take into account the spacing.</p>
<p>here is a dcmdump:</p>
<h1><a name="p-29430-dicom-file-format-1" class="anchor" href="#p-29430-dicom-file-format-1" aria-label="Heading link"></a>Dicom-File-Format</h1>
<h1><a name="p-29430-dicom-meta-information-header-2" class="anchor" href="#p-29430-dicom-meta-information-header-2" aria-label="Heading link"></a>Dicom-Meta-Information-Header</h1>
<h1><a name="p-29430-used-transfersyntax-little-endian-explicit-3" class="anchor" href="#p-29430-used-transfersyntax-little-endian-explicit-3" aria-label="Heading link"></a>Used TransferSyntax: Little Endian Explicit</h1>
<p>(0002,0000) UL 188                                      #   4, 1 FileMetaInformationGroupLength<br>
(0002,0001) OB 00\01                                    #   2, 1 FileMetaInformationVersion<br>
(0002,0002) UI =SecondaryCaptureImageStorage            #  26, 1 MediaStorageSOPClassUID<br>
(0002,0003) UI [1.4.444.0.1.4.560454010.10948.1568207717.271] #  44, 1 MediaStorageSOPInstanceUID<br>
(0002,0010) UI =LittleEndianExplicit                    #  20, 1 TransferSyntaxUID<br>
(0002,0012) UI [1.2.276.0.7230010.3.0.3.6.4]            #  28, 1 ImplementationClassUID<br>
(0002,0013) SH [OFFIS_DCMTK_364]                        #  16, 1 ImplementationVersionName</p>
<h1><a name="p-29430-dicom-data-set-4" class="anchor" href="#p-29430-dicom-data-set-4" aria-label="Heading link"></a>Dicom-Data-Set</h1>
<h1><a name="p-29430-used-transfersyntax-little-endian-explicit-5" class="anchor" href="#p-29430-used-transfersyntax-little-endian-explicit-5" aria-label="Heading link"></a>Used TransferSyntax: Little Endian Explicit</h1>
<p>(0008,0005) CS [ISO_IR 100]                             #  10, 1 SpecificCharacterSet<br>
(0008,0016) UI =SecondaryCaptureImageStorage            #  26, 1 SOPClassUID<br>
(0008,0018) UI [1.4.444.0.1.4.560454010.10948.1568207717.271] #  44, 1 SOPInstanceUID<br>
(0008,0020) DA [20151214]                               #   8, 1 StudyDate<br>
(0008,0021) DA [20151214]                               #   8, 1 SeriesDate<br>
(0008,0022) DA [20151214]                               #   8, 1 AcquisitionDate<br>
(0008,0023) DA [20151214]                               #   8, 1 ContentDate<br>
(0008,0030) TM [000000.0000]                            #  12, 1 StudyTime<br>
(0008,0031) TM [000000.0000]                            #  12, 1 SeriesTime<br>
(0008,0032) TM [180136.136]                             #  10, 1 AcquisitionTime<br>
(0008,0033) TM [180136.136]                             #  10, 1 ContentTime<br>
(0008,0050) SH (no value available)                     #   0, 0 AccessionNumber<br>
(0008,0060) CS [OPT]                                    #   4, 1 Modality<br>
(0008,0070) LO [xxx]                 #  22, 1 Manufacturer<br>
(0008,0090) PN (no value available)                     #   0, 0 ReferringPhysicianName<br>
(0008,0221) CS [OCT]                                    #   4, 1 EquipmentModality<br>
(0008,103e) LO [SlicesOPT]                              #  10, 1 SeriesDescription<br>
(0008,1070) PN [GYS]                                    #   4, 1 OperatorsName<br>
(0008,1090) LO [Spectralis]                             #  10, 1 ManufacturerModelName<br>
(0010,0010) PN [visit x]          #  30, 1 PatientName<br>
(0010,0020) LO [LOC6053359.1.3.6.1.4.1.33437.10.7.2548426.13094654189.13010.7] #  62, 1 PatientID<br>
(0010,0030) DA [19000101]                               #   8, 1 PatientBirthDate<br>
(0010,0040) CS [F]                                      #   2, 1 PatientSex<br>
(0010,1010) AS (no value available)                     #   0, 0 PatientAge<br>
(0018,0050) DS [0.0598645833333333]                     #  18, 1 SliceThickness<br>
(0018,5100) CS [HFP]                                    #   4, 1 PatientPosition<br>
(0020,000d) UI [LOC13309808.1.3.6.1.4.1.33437.10.8.2673601.13094590126.7801.8] #  62, 1 StudyInstanceUID<br>
(0020,000e) UI [LOC13309808.1.3.6.1.4.1.33437.10.9.2673601.13094590127.7801.9] #  62, 1 SeriesInstanceUID<br>
(0020,0010) SH <span class="chcklst-box fa fa-square-o fa-fw"></span>                            #  12, 1 StudyID<br>
(0020,0011) IS [1]                                      #   2, 1 SeriesNumber<br>
(0020,0013) IS [15]                                     #   2, 1 InstanceNumber<br>
(0020,0032) DS [0\0\0.89796875]                         #  14, 3 ImagePositionPatient<br>
(0020,0037) DS [1\0\0\0\1\0]                            #  12, 6 ImageOrientationPatient<br>
(0020,0052) UI [1.4.444.0.1.3.560454010.10948.1568207717.256] #  44, 1 FrameOfReferenceUID<br>
(0020,0060) CS [L]                                      #   2, 1 Laterality<br>
(0020,1041) DS [0.89796875]                             #  10, 1 SliceLocation<br>
(0028,0002) US 1                                        #   2, 1 SamplesPerPixel<br>
(0028,0004) CS [MONOCHROME2]                            #  12, 1 PhotometricInterpretation<br>
(0028,0008) IS [1]                                      #   2, 1 NumberOfFrames<br>
(0028,0010) US 496                                      #   2, 1 Rows<br>
(0028,0011) US 1024                                     #   2, 1 Columns<br>
(0028,0030) DS [0.0057\0.0039]                          #  14, 2 PixelSpacing<br>
(0028,0100) US 8                                        #   2, 1 BitsAllocated<br>
(0028,0101) US 8                                        #   2, 1 BitsStored<br>
(0028,0102) US 7                                        #   2, 1 HighBit<br>
(0028,0103) US 0                                        #   2, 1 PixelRepresentation<br>
(7fe0,0010) OB 00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00… # 507904, 1 PixelData</p>
<p>I’ll upload some data soon.</p>

---

## Post #17 by @pdeman (2019-09-11 14:56 UTC)

<p>I can’t upload .dcm on the forum</p>

---

## Post #18 by @pieper (2019-09-11 15:11 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="16" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>(0008,0016) UI =SecondaryCaptureImageStorage # 26, 1 SOPClassUID</p>
</blockquote>
</aside>
<p>When the data is a secondary capture it basically means screenshot, which isn’t really a volumetric format.</p>
<aside class="quote no-group" data-username="pdeman" data-post="17" data-topic="7338" data-full="true">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>I can’t upload .dcm on the forum</p>
</blockquote>
</aside>
<p>You can use dropbox, google drive, one drive, etc to share the data.</p>

---

## Post #19 by @pdeman (2019-09-12 07:26 UTC)

<p>yes but it doesn’t work with opthalmic tomographic uid neither, even if they are volumetric format.<br>
so indeed if I specify for example a CTImageStorage sop class uid, it works.<br>
but it’s not a CTImageStorage …<br>
how can I know which sop class uid are managed by slicer ?</p>

---

## Post #20 by @lassoan (2019-09-12 13:54 UTC)

<p>There is no restriction in term of SOP Class UID, but Slicer’s Scalar volume DICOM reader plugin requires image geometry information defined by slice position and orientation tags.</p>
<p>If ophtalmic tomographic image IOD does not require these fields then you need to create your own DICOM plugin for reading this type of image. A plugin would probably be just a few ten lines of Python code that computes image origin, spacing, and axis directions from DICOM tags - see my <a href="https://discourse.slicer.org/t/cant-load-dicom-images-generated-by-dcmtk/7338/5">post above</a> for details.</p>

---

## Post #21 by @pdeman (2019-09-12 13:58 UTC)

<p>[quote=“lassoan, post:20, topic:7338”]<br>
Slicer’s Scalar volume DICOM reader plugin requires image geometry information defined by slice position and orientation tags.<br>
[/quote] and you can see them on the dcmdump that I posted.</p>
<p>they are present. as I said,</p>
<blockquote>
<p>self.targetCorners<br>
read from the dicom header in this python script are correct.</p>
</blockquote>
<p>if I transform the dicom in nifti the transformation matrix is correct.</p>
<p>the problem comes from ```<br>
volumeNode.GetIJKToRASMatrix(ijkToRAS)</p>
<pre><code class="lang-auto"></code></pre>

---

## Post #22 by @pieper (2019-09-12 14:13 UTC)

<p>Hi <a class="mention" href="/u/pdeman">@pdeman</a> -  I’m sure we can sort this out - I don’t have much experience with OCT, but I agree with Andras we should be able to make a custom DICOMPlugin that handles the specifics of this data.</p>
<p>The existing ScalarVolume plugin delegates to ITK for dicom reading, since there are a lot of legacy issues handled by the dcmtk and gdcm readers, but they don’t handle OCT well either.  Best is to write a new reader with pydicom that is aware of the needs of this use case.</p>

---

## Post #23 by @fedorov (2019-09-12 14:34 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="19" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>how can I know which sop class uid are managed by slicer ?</p>
</blockquote>
</aside>
<p>I think this is a good point. You cannot. I think we should have a resource that lists which SOP class UIDs are supported, and which extensions are needed when this capability is not available in the main application.</p>

---

## Post #24 by @pdeman (2019-09-16 07:13 UTC)

<p>but in dicomscalarplugin,<br>
if the geometry from the dicom header read in self.targetCorners is correct,<br>
but different from the geometry in self.originalCorners isn’t it possible to “force” to use the geometry read in self.targetCorners?</p>

---

## Post #25 by @pieper (2019-09-16 14:59 UTC)

<p>Hi -</p>
<p>I don’t know the OCT use case, but the geometry correction code is used for missing slices or sheared slice planes.  Do either of these come up in OCT?  I still think the best bet is to put the data in a preferred dicom instance and then write a slicer dicom plugin to handle it directly.</p>

---

## Post #26 by @pdeman (2019-09-17 08:24 UTC)

<p>no it doesn’t occur in OCT. at least I have never seen that.<br>
I don’t think that modifying the dicom sop class uid one generated dicom, especially to put an sop class uid which is not the correct one, is a good idea.</p>

---

## Post #27 by @pieper (2019-09-17 16:15 UTC)

<aside class="quote no-group" data-username="pdeman" data-post="26" data-topic="7338">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/p/9fc348/48.png" class="avatar"> pdeman:</div>
<blockquote>
<p>I don’t think that modifying the dicom sop class uid one generated dicom, especially to put an sop class uid which is not the correct one, is a good idea.</p>
</blockquote>
</aside>
<p>Hmm, I don’t think we’re communicating well.  I’m suggesting you find the correct DICOM encoding of your data and then we figure out the best way to read that in Slicer (probably through a custom plugin that understands that SOP class).  Is there a standard SOP class for the data you have?</p>

---
