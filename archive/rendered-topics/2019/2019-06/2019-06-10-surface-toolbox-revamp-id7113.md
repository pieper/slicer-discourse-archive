# Surface toolbox revamp

**Topic ID**: 7113
**Date**: 2019-06-10
**URL**: https://discourse.slicer.org/t/surface-toolbox-revamp/7113

---

## Post #1 by @bpaniagua (2019-06-10 15:06 UTC)

<p>Hi Slicer developers,<br>
cc: <a class="mention" href="/u/pieper">@pieper</a> <a class="mention" href="/u/lassoan">@lassoan</a> <a class="mention" href="/u/jcfr">@jcfr</a> <a class="mention" href="/u/styner">@styner</a></p>
<p>This week we plan to start a considerable effort to revamp <a href="https://github.com/Slicer/Slicer/blob/d308a019361738d2cf4f827cddab5b4896a63f23/Modules/Scripted/SurfaceToolbox/SurfaceToolbox.py">the Surface Toolbox</a>. The main idea is to port most of <a href="https://github.com/NIRALUser/SPHARM-PDM/blob/master/Modules/CLI/MetaMeshTools/MeshMath.cxx">MeshMath’s functionality</a> into it. We have created a <a href="https://www.slicer.org/wiki/Documentation/Labs/Surface_Toolbox_update">lab’s page</a> that details how we plan this effort to go.</p>
<p>If anybody has ideas or suggestions, please let us know!</p>
<p>Bea</p>

---

## Post #2 by @jcfr (2019-07-10 16:06 UTC)

<p><a class="mention" href="/u/benwilson">@benwilson</a> is making good progress and should have a pull request shortly <img src="https://emoji.discourse-cdn.com/twitter/tada.png?v=9" title=":tada:" class="emoji" alt=":tada:"></p>
<p>To move forward, considering we will be adding around ~20 CLIs, I was thinking to develop the SurfaceToolBox (and associated modules) in its own repository <strong>Slicer/Slicer-SurfaceToolBox</strong> that we would integrate in Slicer as a remote module like it is already done for <code>SimpleFilters</code>, <code>LandmarkRegistration</code>, …</p>
<p>What do you think ?</p>
<p>This would allow …</p>
<ul>
<li>to easily enable/disable building of the surface toolbox within Slicer or Slicer custom application</li>
<li>to easily integrate the modules in any system compliant with the SlicerExecutionModel interface</li>
</ul>
<p>To illustrate here is a repository I just created:</p>
<aside class="onebox whitelistedgeneric">
  <header class="source">
      <img src="https://github.githubassets.com/favicon.ico" class="site-icon" width="32" height="32">
      <a href="https://github.com/Slicer/Slicer-SurfaceToolBox" target="_blank" rel="nofollow noopener">GitHub</a>
  </header>
  <article class="onebox-body">
    <img src="https://avatars3.githubusercontent.com/u/324362?s=400&amp;amp;v=4" class="thumbnail onebox-avatar" width="400" height="400">

<h3><a href="https://github.com/Slicer/Slicer-SurfaceToolBox" target="_blank" rel="nofollow noopener">Slicer/Slicer-SurfaceToolBox</a></h3>

<p>Contribute to Slicer/Slicer-SurfaceToolBox development by creating an account on GitHub.</p>


  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>

<p>It was generated by extracting history using <a href="https://github.com/jcfr/dockgit-rocket-filter#readme" rel="nofollow noopener">jcfr/dockgit-rocket-filter</a>:</p>
<pre><code class="lang-nohighlight"># Filter history
git clone git://github.com/Slicer/Slicer -b master Slicer-SurfaceToolBox
cd Slicer-SurfaceToolBox
git-rocket-filter --branch surfacetoolbox --keep Modules/Scripted/SurfaceToolbox

# publish extracted branch
git remote add SurfaceToolBox git@github.com:Slicer/Slicer-SurfaceToolBox.gi
git push SurfaceToolBox refs/heads/surfacetoolbox:master
</code></pre>

---

## Post #3 by @pieper (2019-07-10 18:56 UTC)

<p>Sounds like a good idea to me - thanks <a class="mention" href="/u/jcfr">@jcfr</a> <img src="https://emoji.discourse-cdn.com/twitter/+1.png?v=9" title=":+1:" class="emoji" alt=":+1:"></p>

---

## Post #4 by @jcfr (2019-07-10 22:46 UTC)

<p>Thanks for the feedback.</p>
<ul>
<li>Repository name changed to <code>SlicerSurfaceToolbox</code>
</li>
<li>
<code>LICENSE</code>, <code>README.md</code> and top-level <code>CMakeLists.txt</code> added</li>
<li>History filtered to have all modules at the root of the repo and to fix the the git message trailers so that both <code>Co-authored-by</code> and <code>git-svn-id</code> are recognized</li>
</ul>

---

## Post #5 by @lassoan (2019-07-19 03:53 UTC)

<p>A post was split to a new topic: <a href="/t/convert-mesh-to-engineering-cad-software-solid-part/7679">Convert mesh to engineering CAD software solid part</a></p>

---

## Post #6 by @jcfr (2019-08-12 14:59 UTC)

<p>Start with <a href="http://viewvc.slicer.org/viewvc.cgi/Slicer4?view=revision&amp;revision=28434" rel="nofollow noopener">r28434</a>, SurfaceToolbox is now integrated as a remote module whose sources are downloaded from <a href="https://github.com/Slicer/SlicerSurfaceToolbox" rel="nofollow noopener">https://github.com/Slicer/SlicerSurfaceToolbox</a></p>

---

## Post #7 by @rprueckl (2019-09-13 07:06 UTC)

<p>Hi!</p>
<p>I was considering expanding the Connectivity option of the surface toolbox such, that not only the largest region is extracted, but to base the extraction on a volumetric threshold (I remember seeing a comment in the Python source code of the module in 4.10.2 regarding this). So I tried (in Python) to prototype something like this, without great success. Below is my prototype code.</p>
<pre><code class="lang-auto">input = slicer.mrmlScene.GetFirstNodeByName('Model')
surface = input.GetPolyDataConnection()

# get all regions
conn = vtk.vtkPolyDataConnectivityFilter()
conn.ScalarConnectivityOn()
conn.SetScalarRange(-1, 1)
conn.SetExtractionModeToAllRegions()
conn.SetInputConnection(surface)
conn.Update()

nrRegions = conn.GetNumberOfExtractedRegions()
sizes = conn.GetRegionSizes()

# now switch to extraction mode to process one after the other  
conn.SetExtractionModeToSpecifiedRegions()

fhf = vtk.vtkFillHolesFilter()
fhf.SetHoleSize(1000.0)
fhf.SetInputConnection(conn.GetOutputPort())

normals = vtk.vtkPolyDataNormals()
normals.ConsistencyOn();
normals.SplittingOff();
normals.SetInputConnection(fhf.GetOutputPort()) 

mass = vtk.vtkMassProperties()
mass.SetInputConnection(normals.GetOutputPort())

volumetricThreshold = 4000
volumes = []

# measure all cells
for id in range(0, nrRegions):
  if sizes.GetValue(id) &gt; 5: # preselect, currently hardcoded
    conn.InitializeSpecifiedRegionList()
    conn.AddSpecifiedRegion(id)
    mass.Update()
    
    print(mass.GetVolume())
    volumes.append(mass.GetVolume())
  else:
    volumes.append(0)
    
fhf.RemoveAllInputConnections(0)      
  
# extract only those regions above the volumetricThreshold
conn.InitializeSpecifiedRegionList()
for id in range(0, nrRegions):
  if volumes[id] &gt; volumetricThreshold:
    print(id)
    conn.AddSpecifiedRegion(id)

surface = conn.GetOutputPort()
input.SetPolyDataConnection(surface)
conn.Update()
</code></pre>
<p>Can someone tell me whether this goes into the right direction? In principle, it seems to do what it should (I believe, I have not rigorously tested it), but it is extremely slow (takes about 2 minutes for a CT-head). Is there a significant difference between Python implementation and C++? If we could get something like this running, it would be suited for expanding <a href="https://github.com/Slicer/SlicerSurfaceToolbox/blob/master/Connectivity/Connectivity.cxx" rel="nofollow noopener">this</a> module.</p>
<p>BTW: I did not see any difference in extraction when I manipulated the ScalarRange or turned FullScalarConnectivityOn().</p>

---

## Post #8 by @lassoan (2019-09-13 15:22 UTC)

<p>For segmentation problems like this, we normally use the Segment Editor:</p>
<ol>
<li>Use Threshold effect to specify intensity range you are interested in.</li>
<li>Use Islands effect / Keep largest island method to keep the largest connected component.</li>
</ol>
<p>You can continue with further processing or export directly to STL/OBJ file right from the Segment Editor.</p>

---
