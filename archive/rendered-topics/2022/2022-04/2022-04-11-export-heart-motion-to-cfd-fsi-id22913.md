---
topic_id: 22913
title: "Export Heart Motion To Cfd Fsi"
date: 2022-04-11
url: https://discourse.slicer.org/t/22913
---

# Export heart motion to CFD/FSI

**Topic ID**: 22913
**Date**: 2022-04-11
**URL**: https://discourse.slicer.org/t/export-heart-motion-to-cfd-fsi/22913

---

## Post #1 by @Gening_Dong (2022-04-11 18:54 UTC)

<p>Hello, I have a really similar question to this. I want to get the coordinates of the segmented heart’s surface.<br>
I used the Sequence Registration and the module Transform to transform a model generated by the module Segmentation. I want to export the time-varying coordinates information of meshing points (vertices) on that 3D model surface, so that I can use the motion of boundary to run CFD/FSI.<br>
I tried to add the meshing points as nodes in the module Markups. But there are more than 20,000 points so that seems impossible to add them all as markups.</p>

---

## Post #2 by @lassoan (2022-04-11 19:03 UTC)



---

## Post #3 by @lassoan (2022-04-11 19:08 UTC)

<p>You can get mesh point positions as a numpy array using <a href="https://slicer.readthedocs.io/en/latest/developer_guide/slicer.html#slicer.util.arrayFromModelPoints"><code>slicer.util.arrayFromModelPoints</code></a>. Note that you need to harden the transform on the model node to get the transformed coordinates in the array.</p>
<p>Once you have the mesh point positions in a numpy array, you can then write the values into any format that your CFD/FSI engine can digest.</p>

---

## Post #4 by @Gening_Dong (2022-04-11 19:50 UTC)

<p>Thanks for your reply!<br>
I’m quite a newie to Slicer and Python. Do I need to run the complete code in Python in order to get the array or I can just run slicer.util.arrayFromModelPoints( <em>modelNode</em> ) using the Python Interactor in the 3D Slicer?<br>
Btw, does the modelNode mean the MRML ID shown in Data?</p>

---

## Post #5 by @Gening_Dong (2022-04-11 19:51 UTC)

<p>Thanks for your reply!<br>
I’m quite a newie to Slicer and Python. Do I need to run the complete code in Python in order to get the array or I can just run slicer.util.arrayFromModelPoints( <em>modelNode</em> ) using the Python Interactor in the 3D Slicer?<br>
Btw, does the modelNode mean the MRML ID shown in Data?</p>

---

## Post #6 by @lassoan (2022-04-11 20:04 UTC)

<p>You open the Python console in Slicer (or use Jupyter notebook interface via <a href="https://github.com/Slicer/SlicerJupyter#slicerjupyter">SlicerJupyter</a>) and run <code>slicer.util.arrayFromModelPoints</code> there. You can get <code>modelNode</code> using <code>slicer.util.getNode()</code> function. You can find many useful code snippets in the <a href="https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html">script repository</a>.</p>
<p>To get started with Python programming in Slicer, you can check out the <a href="https://github.com/PerkLab/PerkLabBootcamp/blob/master/Doc/day3_2_SlicerProgramming.pptx?raw=true">PerkLab Slicer programming tutorial</a>.</p>

---

## Post #7 by @Gening_Dong (2022-04-14 20:51 UTC)

<p>Hi Lasso,</p>
<p>Sorry to bother you again, but I’m really a newie to Python and I still got some confusions regarding the mesh point positions.</p>
<p>I got this numpy array using the method you suggested, however, I don’t think I understand what does this array actually mean. I think the three numbers in each line mean the position of one mesh point, but I just don’t know what is the corresponding time point of these coordinates. In addition, are these RAS coordinates or LAS coordinates?</p>
<p>I’d like to write these values into a table-like format. For example, t=0s: coordinates of each mesh point are [x1,y1,z1] [x2,y2,z2] …; t=1s: coordinates of each mesh point are [x1’,y1’,z1’] [x2’,y2’,z2’] …</p>
<p>Do you know what should I do? Thanks a lot!</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/8/d/8dacb43e801233a8bf6d4d8f26156816464e002a.jpeg" data-download-href="/uploads/short-url/kdjl5p1dWfbhyPNf5wScSRhMOca.jpeg?dl=1" title="Screenshot 2022-04-14 163619" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/2X/8/8dacb43e801233a8bf6d4d8f26156816464e002a_2_690x316.jpeg" alt="Screenshot 2022-04-14 163619" data-base62-sha1="kdjl5p1dWfbhyPNf5wScSRhMOca" width="690" height="316" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/2X/8/8dacb43e801233a8bf6d4d8f26156816464e002a_2_690x316.jpeg, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/8/d/8dacb43e801233a8bf6d4d8f26156816464e002a.jpeg 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/8/d/8dacb43e801233a8bf6d4d8f26156816464e002a.jpeg 2x" data-dominant-color="F4F5F5"><div class="meta">
<svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot 2022-04-14 163619</span><span class="informations">728×334 60.3 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg>
</div></a></div></p>

---

## Post #8 by @Gening_Dong (2022-04-14 21:25 UTC)

<p>A quick update. I saved the numpy array as a csv file and found that there are 91933 coordinates, which is exactly the number of mesh points. So I think this is only the coordinates at time=0s? How can I get the coordinates in different time points?</p>

---

## Post #9 by @lassoan (2022-04-14 23:13 UTC)

<p>You can step through the time sequence and export coordinates at each timepoint. You can find an example of how to step through all timepoints <a href="https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html#browse-a-sequence-and-access-currently-displayed-nodes">here</a>.</p>

---

## Post #10 by @Gening_Dong (2022-04-15 17:30 UTC)

<p>I read through that sample and realized that in order to step through all timepoints, it needs to browse a sequence. I copied a part of the sample code below, does it mean that I can only get the coordinates of the volume at different time points? But instead I’d like to get the coordinates of a model, not the volume.<br>
Thanks!</p>
<p><strong># Get currently displayed volume node voxels as numpy array</strong><br>
volumeNode = browserNode.GetProxyNode(sequenceNode)<br>
voxelArray = slicer.util.arrayFromVolume(volumeNode)</p>

---

## Post #11 by @Gening_Dong (2022-04-15 17:30 UTC)

<p>I read through that sample and realized that in order to step through all timepoints, it needs to browse a sequence. I copied a part of the sample code below, does it mean that I can only get the coordinates of the volume at different time points? But instead I’d like to get the coordinates of a model, not the volume.<br>
Thanks!</p>
<p><strong># Get currently displayed volume node voxels as numpy array</strong><br>
volumeNode = browserNode.GetProxyNode(sequenceNode)<br>
voxelArray = slicer.util.arrayFromVolume(volumeNode)</p>

---

## Post #12 by @lassoan (2022-04-15 18:07 UTC)

<p>The browser node iterates through all the associated sequences - volumes, transforms, models, etc.</p>

---

## Post #13 by @Gening_Dong (2022-04-15 19:46 UTC)

<p>Sorry but I can’t really get it. How can I connect my <code>modelNode</code> to the <code>sequenceNode</code> or <code>browserNode</code>?<br>
When I jumped to a selected sequence item using <code>browserNode.SetSelectedItemNumber()</code>, and tried to get currently displayed model node using <code>slicer.util.getNode()</code> and <code>slicer.util.arrayFromModelPoints()</code>, it still output the coordinates at the initial time point.</p>

---

## Post #14 by @Gening_Dong (2022-04-15 19:47 UTC)

<p>Sorry but I can’t really get it. How can I connect my <code>modelNode</code> to the <code>sequenceNode</code> or <code>browserNode</code> ?<br>
When I jumped to a selected sequence item using <code>browserNode.SetSelectedItemNumber()</code> , and tried to get currently displayed model node using <code>slicer.util.getNode()</code> and <code>slicer.util.arrayFromModelPoints()</code> , it still output the coordinates at the initial time point.</p>

---

## Post #15 by @lassoan (2022-04-15 20:01 UTC)

<p>I don’t think you have a model sequence. I guess you have a transform sequence, so you would iterate through that. At each timepoint you clone your model node (to keep the original non-transformed point coordinates), apply the current transform to the model, then save the transformed model.</p>

---

## Post #16 by @Gening_Dong (2022-04-15 20:29 UTC)

<p><a class="mention" href="/u/lassoan">@lassoan</a><br>
I found an example <a href="https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html#export-nodes-warped-by-transform-sequence" rel="noopener nofollow ugc">here</a>, so I need to jump to each selected sequence item using <code>browserNode.SetSelectedItemNumber()</code> and apply the transform? Do I need to firstly convert the model  into segmentation in order to apply the transform? Thanks a lot.</p>

---

## Post #17 by @lassoan (2022-04-15 21:50 UTC)

<p>That example is perfect. It does not clone the model node but resets the model node content from the segmentation node at each timepoint.</p>
<p>You don’t have to use the browser node, you can just get the transform node from the sequence as it is shown in the example.</p>

---

## Post #18 by @Gening_Dong (2022-04-15 23:12 UTC)

<p><a class="mention" href="/u/lassoan">@lassoan</a></p>
<p>When I try to run the <code>for</code> loop in that example, I met some Attribute Errors as shown below. I can’t really get it, what do these errors indicate? I used exactly the same code as that <a href="https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html#export-nodes-warped-by-transform-sequence" rel="noopener nofollow ugc">example</a>.</p>
<p><code>AttributeError: 'MRMLCorePython.vtkMRMLTransformNode' object has no attribute 'GetNumberOfDataNodes'</code></p>
<p><code>AttributeError: 'MRMLCorePython.vtkMRMLTransformNode' object has no attribute 'GetNthDataNode'</code></p>

---

## Post #19 by @lassoan (2022-04-16 01:19 UTC)

<p>The code is correct. You got the error because as <code>transformSequenceNode</code> you provided a simple transform node.</p>
<p>This transform node that you got from the scene is most likely a “proxy node” for the transform sequence, i.e., a node that exposes the transform at the selected timepoint in the scene. You can get the sequence node from a proxy node like this:</p>
<pre><code class="lang-python">proxyNode = getNode(...)
browserNode = slicer.modules.sequences.logic().GetFirstBrowserNodeForProxyNode(proxyNode)
sequenceNode = browserNode.GetSequenceNode(proxyNode)
</code></pre>

---

## Post #20 by @Gening_Dong (2022-04-21 14:34 UTC)

<p>Hi <a class="mention" href="/u/lassoan">@lassoan</a> , thanks for your help with the position extracting. However I met another problem right now: I want to calculate strain tensor of the boundary. I read your suggestion <a href="https://discourse.slicer.org/t/4d-cardiac-ct-strain-analysis/22789/3">here</a> so I’m trying to export the displacement field.</p>
<p>I found an example for extracting displacement field <a href="https://slicer.readthedocs.io/en/latest/developer_guide/script_repository.html#export-the-displacement-magnitude-of-the-transform-as-a-volume" rel="noopener nofollow ugc">here</a>. However, I only want the displacement field in the segmentation/model, but not the entire volume. Can I transfer a segmentation into a new volume so that I can export the displacement magnitude of the transform as a volume and visualize it? Or do you have any other ideas to get the displacement field of a model?</p>
<p>Thanks a lot!</p>

---

## Post #21 by @lassoan (2022-04-25 04:30 UTC)

<p>You can get the displacement vector for each point by subtracting the original point coordinates from the moved point coordinates.</p>

---
