# OpenAnatomy gltf changing mesh colors

**Topic ID**: 21655
**Date**: 2022-01-27
**URL**: https://discourse.slicer.org/t/openanatomy-gltf-changing-mesh-colors/21655

---

## Post #1 by @tsehrhardt (2022-01-27 14:47 UTC)

<p>I downloaded the latest preview release to try the updated OpenAnatomy GLTF export to view in <a href="http://3Dviewer.net" rel="noopener nofollow ugc">3Dviewer.net</a> and Sketchfab. It works well but it’s changing my selected colors. For example, if I have an RGB of 177, 122, 101 for a segment (<span class="hashtag">#b17a65</span>), if I’m doing the correct calculation, the baseColorFactor in my gltf should be 0.4478708429, 0.1975164314, 0.1303522781, but instead it reads 0.347059, 0.2392155, 0.198039 (<span class="hashtag">#9f867b</span>). I can change this manually in the gltf and also in the Sketchfab viewer but just wanted to put it out there. The alpha is correct.</p>

---

## Post #2 by @lassoan (2022-01-29 19:21 UTC)

<p>glTF uses PBR shading model. VTK only supported Phong model until VTK-8.2 (<a href="https://www.kitware.com/vtk-pbr/">now it supports PBR</a> as well) and this is what is currently used in Slicer.</p>
<p>Appearance generated by these models are quite different and material property parameters are quite different:</p>
<ul>
<li>PBR parameters: base color (RGB), metallic (scalar), and roughness (scalar).</li>
<li>Phong parameters: color (RGB) and reflectance (scalar) for ambient, diffuse, specular reflection; and specular power (scalar).</li>
</ul>
<p>It is not possible to reproduce the same appearance with these two models. VTK attempts to compute PBR parameters from Phong this way:</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/Kitware/VTK/blob/64715369564e8d213c61dd6b1d19f1879cc85c83/IO/Export/vtkGLTFExporter.cxx#L470-L478">
  <header class="source">

      <a href="https://github.com/Kitware/VTK/blob/64715369564e8d213c61dd6b1d19f1879cc85c83/IO/Export/vtkGLTFExporter.cxx#L470-L478" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/Kitware/VTK/blob/64715369564e8d213c61dd6b1d19f1879cc85c83/IO/Export/vtkGLTFExporter.cxx#L470-L478" target="_blank" rel="noopener">Kitware/VTK/blob/64715369564e8d213c61dd6b1d19f1879cc85c83/IO/Export/vtkGLTFExporter.cxx#L470-L478</a></h4>



    <pre class="onebox">      <code class="lang-cxx">
        <ol class="start lines" start="470" style="counter-reset: li-counter 469 ;">
            <li>vtkProperty* prop = aPart-&gt;GetProperty();</li>
            <li>double dcolor[3];</li>
            <li>prop-&gt;GetDiffuseColor(dcolor);</li>
            <li>model["baseColorFactor"].append(dcolor[0]);</li>
            <li>model["baseColorFactor"].append(dcolor[1]);</li>
            <li>model["baseColorFactor"].append(dcolor[2]);</li>
            <li>model["baseColorFactor"].append(prop-&gt;GetOpacity());</li>
            <li>model["metallicFactor"] = prop-&gt;GetSpecular();</li>
            <li>model["roughnessFactor"] = 1.0 / (1.0 + prop-&gt;GetSpecular() * 0.2 * prop-&gt;GetSpecularPower());</li>
        </ol>
      </code>
    </pre>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>Unfortunately, this did not work very well - produced too bright, washed-out colors. It is also limited in that it does not take into account ambient and diffuse reflection factors.</p>
<p>I’ve tried to compensate for this in OpenAnatomy exporter here:</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/PerkLab/SlicerOpenAnatomy/blob/fd1456c476bac067980be3a172c14f62b6b505d6/OpenAnatomyExport/OpenAnatomyExport.py#L464-L473">
  <header class="source">

      <a href="https://github.com/PerkLab/SlicerOpenAnatomy/blob/fd1456c476bac067980be3a172c14f62b6b505d6/OpenAnatomyExport/OpenAnatomyExport.py#L464-L473" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/PerkLab/SlicerOpenAnatomy/blob/fd1456c476bac067980be3a172c14f62b6b505d6/OpenAnatomyExport/OpenAnatomyExport.py#L464-L473" target="_blank" rel="noopener">PerkLab/SlicerOpenAnatomy/blob/fd1456c476bac067980be3a172c14f62b6b505d6/OpenAnatomyExport/OpenAnatomyExport.py#L464-L473</a></h4>



    <pre class="onebox">      <code class="lang-py">
        <ol class="start lines" start="464" style="counter-reset: li-counter 463 ;">
            <li>color = displayNode.GetColor()</li>
            <li>ambient = 0.1</li>
            <li>diffuse = 0.5</li>
            <li>specular = 0.2</li>
            <li>actor.GetProperty().SetColor(color[0], color[1], color[2])</li>
            <li>actor.GetProperty().SetAmbientColor(ambient * color[0], ambient * color[1], ambient * color[2])</li>
            <li>actor.GetProperty().SetDiffuseColor(diffuse * color[0], diffuse * color[1], diffuse * color[2])</li>
            <li>actor.GetProperty().SetSpecularColor(specular * color[0], specular * color[1], specular * color[2])</li>
            <li>actor.GetProperty().SetSpecularPower(3.0)</li>
            <li>actor.GetProperty().SetOpacity(displayNode.GetOpacity())</li>
        </ol>
      </code>
    </pre>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>It was not a very sophisticated attempt. I did not look up how the glTF exporter computes the PBR values, just tried to darken the colors based on the ambient, diffuse, specular factors.</p>
<p>It would be nice if you could play around with the OpenAnatomy script to see if you can improve the results.</p>
<p>In the mid/long term, we’ll probably add support for PBR rendering in Slicer and improve VTK’s glTF exporter to allow writing out PBR parameters directly.</p>

---

## Post #3 by @lassoan (2022-03-14 02:38 UTC)

<p>I’ve submitted a fix to VTK that allows setting PBR parameters directly (by setting interpolation mode to PBR in the VTK actor properties), this fix is included in Slicer Preview Release from tomorrow. I’ve also updated SlicerOpenAnatomy extension to take advantage of this and copy PBR material properties directly to the output file. Therefore, for more accurate reproduction of color and surface appearance in glTF files, you can set model display properties to use PBR rendering. When using PBR interpolation it is also recommended to enable image-based lighting, as described <a href="https://discourse.slicer.org/t/new-feature-basic-support-for-physically-based-rendering-pbr/21725">here</a>.</p>
<p>I’ve also updated export of non-PBR materials so that the color is made more saturated during export. This makes the color of the exported models more similar to the original appearance in Slicer.</p>

---
