# Generate segmentation node (binary label map) from centerline

**Topic ID**: 26166
**Date**: 2022-11-09
**URL**: https://discourse.slicer.org/t/generate-segmentation-node-binary-label-map-from-centerline/26166

---

## Post #1 by @RomanStriker (2022-11-09 15:12 UTC)

<p>Hi,</p>
<p>I want to obtain a label map corresponding to centerline generated by VMTK. I would also like to get a different label for voxels belonging to different branches.</p>
<p>I have generated centerline tree for a vessel label map using the ‘extract centerline’ option in VTMK extension Tree → Centerline Model.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/0/4/04195a2b4d13df7e9f8af9828c9974114946fcc4.jpeg" data-download-href="/uploads/short-url/Age3HwXrX4dP4n9wvPekFE7QZ6.jpeg?dl=1" title="Vessel centerline" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/0/4/04195a2b4d13df7e9f8af9828c9974114946fcc4_2_690x401.jpeg" alt="Vessel centerline" data-base62-sha1="Age3HwXrX4dP4n9wvPekFE7QZ6" width="690" height="401" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/0/4/04195a2b4d13df7e9f8af9828c9974114946fcc4_2_690x401.jpeg, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/0/4/04195a2b4d13df7e9f8af9828c9974114946fcc4_2_1035x601.jpeg 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/0/4/04195a2b4d13df7e9f8af9828c9974114946fcc4_2_1380x802.jpeg 2x" data-dominant-color="ACB5C7"><div class="meta">
<svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Vessel centerline</span><span class="informations">1845×1074 103 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg>
</div></a></div></p>
<p>I can right click the Centerline model_1 and select ‘convert model to segmentation node’ which I suppose should result in a binary label map and I can see it in the 3d view but not in any other views. I also exported the label map as .nrrd file and checked the data for any non-zero values, but all the values in the data are zero. Also, when I reload the label map in 3d slicer, I don’t see the centerline at all. Am I understanding the ‘convert model to segmentation node’ option correctly, if so what am I doing wrong here?</p>
<p>I also have another question, I would like to have a heirarchical tree for the whole centerline such that each point on the centerline is associated to a branch of the centerline tree. I can generate this tree using Tree → Centerline Curve option but I have a couple of problems. First, the centerline curve does not match the centerline model, especially at bifurcations. Second, even if would like to use it, I cannot convert this Centerline curve_3 to a segmentation node as there is no option to do that. How can I convert it to a segmentation map?</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/2/1/21deb4096a605b67d8758a782c82a6e6d8b51c0a.jpeg" data-download-href="/uploads/short-url/4PCTywkJCJWtihbsJHPww1N2uMi.jpeg?dl=1" title="Screenshot from 2022-11-08 19-18-09" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/2/1/21deb4096a605b67d8758a782c82a6e6d8b51c0a_2_690x403.jpeg" alt="Screenshot from 2022-11-08 19-18-09" data-base62-sha1="4PCTywkJCJWtihbsJHPww1N2uMi" width="690" height="403" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/2/1/21deb4096a605b67d8758a782c82a6e6d8b51c0a_2_690x403.jpeg, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/2/1/21deb4096a605b67d8758a782c82a6e6d8b51c0a_2_1035x604.jpeg 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/2/1/21deb4096a605b67d8758a782c82a6e6d8b51c0a_2_1380x806.jpeg 2x" data-dominant-color="A7B2BE"><div class="meta">
<svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot from 2022-11-08 19-18-09</span><span class="informations">1846×1079 250 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg>
</div></a></div></p>

---

## Post #2 by @cpinter (2022-11-10 15:12 UTC)

<p>The centerline models just contain the lines that you can see <em>inside</em> the input segmentation. Extracting the parts of the segmentation that belong to each branch is not so simple. First, you need to run <code>vtkvmtkPolyDataCenterlineGroupsClipper</code> on the <code>vtkPolyData</code> of the surface representation of the segmentation. Currently you can only do this from the Python console (I may have missed something and there maybe such module already).</p>
<p>Then to get labelmaps, first you need to “close” down the open-ended surface models so that they can be voxelized to become labelmaps. It is far from simple so I will give you some ideas once you get this far.</p>

---

## Post #3 by @RomanStriker (2022-11-11 15:41 UTC)

<p>I managed to voxelize the centerline curve and get the label map using the Bresenham’s line algorithm. For the centerline model, I see that there are a few arrays that can be useful.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/9/7/978596871ed112a06ca37a9c1bb560da85e1aebc.png" data-download-href="/uploads/short-url/lCqj9OQjqSYX53WESTS8zjOxssc.png?dl=1" title="Screenshot from 2022-11-11 16-36-14" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/7/978596871ed112a06ca37a9c1bb560da85e1aebc_2_690x226.png" alt="Screenshot from 2022-11-11 16-36-14" data-base62-sha1="lCqj9OQjqSYX53WESTS8zjOxssc" width="690" height="226" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/7/978596871ed112a06ca37a9c1bb560da85e1aebc_2_690x226.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/7/978596871ed112a06ca37a9c1bb560da85e1aebc_2_1035x339.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/7/978596871ed112a06ca37a9c1bb560da85e1aebc_2_1380x452.png 2x" data-dominant-color="4A4D4F"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot from 2022-11-11 16-36-14</span><span class="informations">1504×493 144 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>For arrays like Points and Radius, it seems straight forward. EdgeArray should be straight forward as well but I see that the first few edges are connecting to themselves, which is strange in a tree centerline. I have no idea What EdgePCoordArray is. CellPointIds contains 42 lists of ids which I assume can be 42 different branches but I am not sure since the centerline curve for the same segmentation mask contains 72 branches. Can you please help me in understanding what EdgeArray, EdgePCoordArray and CellPointIds are? I think after that I can just use the Bresenham’s line algorithm on the centerline model as well to get my label maps.</p>

---

## Post #4 by @lassoan (2022-11-11 19:48 UTC)

<aside class="quote no-group" data-username="RomanStriker" data-post="3" data-topic="26166">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/r/c37758/48.png" class="avatar"> RomanStriker:</div>
<blockquote>
<p>Can you please help me in understanding what EdgeArray, EdgePCoordArray and CellPointIds are?</p>
</blockquote>
</aside>
<p>You can get a high-level description in <a href="https://lantiga.github.io/media/AntigaPhDThesis.pdf">Luca Antiga’s thesis</a> and you can see examples in how this point and cell data arrays are used in VMTK <a href="https://github.com/vmtk/vmtk/tree/master/vtkVmtk">source code</a>, <a href="https://github.com/vmtk/vmtk/tree/master/vmtkScripts">example scripts</a>, and <a href="https://github.com/vmtk/vmtk/tree/master/PypeS">command-line “pypes”</a>.</p>
<p>For example, here are complete solutions for converting centerline to branching tube mesh or image (that don’t require any external dependencies and blunt methods like Bresenham’s line drawing) here:</p>
<ul>
<li>mesh output: <a href="https://github.com/vmtk/vmtk/blob/master/vmtkScripts/vmtkdistancetocenterlines.py">https://github.com/vmtk/vmtk/blob/master/vmtkScripts/vmtkdistancetocenterlines.py</a></li>
<li>image output: <a href="https://github.com/vmtk/vmtk/blob/master/vmtkScripts/vmtkcenterlinemodeller.py">https://github.com/vmtk/vmtk/blob/master/vmtkScripts/vmtkcenterlinemodeller.py</a></li>
</ul>

---

## Post #5 by @RomanStriker (2022-11-14 15:05 UTC)

<p>I have been meaning to read the Luca’s thesis but I would have to dedicate some time to it later. I tried to use “image output: <a href="https://github.com/vmtk/vmtk/blob/master/vmtkScripts/vmtkcenterlinemodeller.py" rel="noopener nofollow ugc">vmtk/vmtkcenterlinemodeller.py at master · vmtk/vmtk · GitHub</a>” but maybe I am doing something wrong because after ~2 hours I get an image that looks like a smooth gradient.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/6/6/66ad24fb23fc3bb31da0c3f3a4d0b8b533f19c7a.png" data-download-href="/uploads/short-url/eEjF3MvsoqvUJgNqyNLYMhFxuzw.png?dl=1" title="Screenshot from 2022-11-14 16-02-20" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/6/6/66ad24fb23fc3bb31da0c3f3a4d0b8b533f19c7a_2_575x500.png" alt="Screenshot from 2022-11-14 16-02-20" data-base62-sha1="eEjF3MvsoqvUJgNqyNLYMhFxuzw" width="575" height="500" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/6/6/66ad24fb23fc3bb31da0c3f3a4d0b8b533f19c7a_2_575x500.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/6/6/66ad24fb23fc3bb31da0c3f3a4d0b8b533f19c7a_2_862x750.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/6/6/66ad24fb23fc3bb31da0c3f3a4d0b8b533f19c7a_2_1150x1000.png 2x" data-dominant-color="474754"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot from 2022-11-14 16-02-20</span><span class="informations">1190×1034 43.5 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>My code looks like this.</p>
<pre><code class="lang-auto">import vtk
from vmtk import vtkvmtk
import timeit


def centerline_to_image(centerline, ref_image):
    # Read centerline as polydata
    reader = vtk.vtkPolyDataReader()
    reader.SetFileName(centerline)
    reader.Update()
    centerline = reader.GetOutput()

    # Read image
    nifti_reader = vtk.vtkNIFTIImageReader()
    nifti_reader.SetFileName(ref_image)
    nifti_reader.Update()

    modeller = vtkvmtk.vtkvmtkPolyBallModeller()
    modeller.SetInputData(centerline)
    modeller.SetRadiusArrayName("Radius")
    modeller.UsePolyBallLineOn()
    modeller.SetReferenceImage(nifti_reader.GetOutput())
    modeller.SetNegateFunction(0)
    modeller.Update()
    image = modeller.GetOutput()

    return image


if __name__ == '__main__':
    centerline = "path to .vtk centerline"
    ref_image = "path to reference nifty image"

    start = timeit.default_timer()
    image = centerline_to_image(centerline, ref_image)
    stop = timeit.default_timer()
    print('Time: ', stop - start)

    # Write image
    writer = vtk.vtkNIFTIImageWriter()
    writer.SetFileName("path to save nifty image")
    writer.SetInputData(image)
    writer.Write()

</code></pre>

---

## Post #6 by @Aryan_Moradi (2026-02-16 01:03 UTC)

<p>Hello team,</p>
<p>I hope you are well. I was wodering if there is any updates on this? Im facing the same issue, whereas in my case, the modeller generates a gradient like cube, even when i crop the the source image to make computation faster. Any help or guidance would be appreciated.</p>

---
