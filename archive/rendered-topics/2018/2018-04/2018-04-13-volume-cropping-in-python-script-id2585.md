---
topic_id: 2585
title: "Volume Cropping In Python Script"
date: 2018-04-13
url: https://discourse.slicer.org/t/2585
---

# Volume Cropping in Python Script

**Topic ID**: 2585
**Date**: 2018-04-13
**URL**: https://discourse.slicer.org/t/volume-cropping-in-python-script/2585

---

## Post #1 by @brhoom (2018-04-13 20:09 UTC)

<p>Dear all,<br>
I just checked <a href="https://www.slicer.org/wiki/Documentation/Nightly/Developers/Python_scripting" rel="nofollow noopener">Python_scripting</a> and <a href="https://www.slicer.org/wiki/Documentation/Nightly/ScriptRepository" rel="nofollow noopener">ScriptRepository</a> pages and couldn’t find an example for cropping an image, I wrote this simple example. It runs without problem inside a module or extension but when I run it in an external python script it also runs and produces the correct output cropped image but there are error messages I don’t understand. Here is the mentioned complete script code:</p>
<pre><code> from __main__ import vtk, qt, ctk, slicer
 import sitkUtils

 print("                   myScript ")

 inputVolumeFnm  = ./myVolume.nrrd"  
 croppedImageFnm = "./myCroppedVolume.nrrd"

 [success, inputVolume] = slicer.util.loadVolume(inputVolumeFnm, returnNode=True)          
 inputImage = sitkUtils.PullVolumeFromSlicer(inputVolume.GetID())

 cropper = sitkUtils.sitk.CropImageFilter()
 croppingBounds = [[178, 210, 67],[227, 195, 34]]  
 croppedImage = cropper.Execute(inputImage, croppingBounds[0], croppingBounds[1]) 
 croppedNode = sitkUtils.PushVolumeToSlicer(croppedImage, None,  inputVolume.GetName() , 
 'vtkMRMLScalarVolumeNode' )

 properties = {}
 properties["fileType"] = ".nrrd"
 slicer.util.saveNode(croppedNode, croppedImageFnm, properties)

 print(" All tasks are done!  ") 

 exit()
</code></pre>
<p>Despite the correct output cropped image,  I get this output in the terminal:</p>
<pre><code>~/sw/Slicer-4.8.1/Slicer --no-main-window --python-script ./myScript.py
Qt: Cannot set locale modifiers: 
Number of registered modules: 150 
Number of instantiated modules: 150 
Number of loaded modules: 150 
               myScript 
Loaded volume from file: ./myVolume.nrrd. Dimensions: 485x485x121. Number of components: 1. Pixel type: short.
"Volume" Reader has successfully read the file     "./myVolume.nrrd" "[0.56s]" 
vtkITKArchetypeImageSeriesReader::ExecuteInformation: Archetype file ./_DUMMY_DOES_NOT_EXIST__ does not exist.
Algorithm vtkITKArchetypeDiffusionTensorImageReaderFile(0x4a977b0) returned failure for request: 
vtkInformation (0x4a9aea0)
 Debug: Off
 Modified Time: 827149
 Reference Count: 1
 Registered Events: (none)
 Request: REQUEST_INFORMATION
 ALGORITHM_AFTER_FORWARD: 1
 FORWARD_DIRECTION: 0
vtkITKArchetypeImageSeriesReader::ExecuteInformation: Archetype file ./_DUMMY_DOES_NOT_EXIST__ does not exist.
 Algorithm vtkITKArchetypeImageSeriesVectorReaderSeries(0x48edfb0) returned failure for request: vtkInformation (0x4a978f0)
  Debug: Off
  Modified Time: 828705
  Reference Count: 1
  Registered Events: (none)
 Request: REQUEST_INFORMATION
  ALGORITHM_AFTER_FORWARD: 1
  FORWARD_DIRECTION: 0
 vtkITKArchetypeImageSeriesReader::ExecuteInformation: Archetype file /_DUMMY_DOES_NOT_EXIST__ 
 does not exist.
 Algorithm vtkITKArchetypeImageSeriesScalarReader(0x4a6be60) returned failure for request: vtkInformation (0x4a8c600)
  Debug: Off
  Modified Time: 829510
  Reference Count: 1
  Registered Events: (none)
  Request: REQUEST_INFORMATION
  ALGORITHM_AFTER_FORWARD: 1
  FORWARD_DIRECTION: 0
  ReadData: This is not a nrrd file
  ReadData: Cannot read file as a volume of type DiffusionTensorVolume[fullName 
         /_DUMMY_DOES_NOT_EXIST__]
Number of files listed in the node = 0.
File reader says it was able to read 0 files.
File reader used the archetype file name of //_DUMMY_DOES_NOT_EXIST__ []
  FileNotFoundError
  ReadData: This is not a nrrd file
  ReadData: Failed to instantiate a file reader
  ReadData: Cannot read file as a volume of type Volume[fullName = /_DUMMY_DOES_NOT_EXIST__]
Number of files listed in the node = 0.
File reader says it was able to read 0 files.
File reader used the archetype file name of /_DUMMY_DOES_NOT_EXIST__ []
   FileNotFoundError
  Generic Warning: In /home/kitware/Dashboards/Package/Slicer- 
 481/Libs/MRML/Core/vtkDataFileFormatHelper.cxx, line 237
 vtkDataFileFormatHelper::GetFileExtensionFromFormatString: please update deprecated extension-only 
 format specifier to 'File format name (.ext)' format! Current format string: .nrrd
 All tasks are done!</code></pre>

---

## Post #2 by @lassoan (2018-04-14 05:10 UTC)

<p>This warning is generated by a <a href="https://github.com/Slicer/Slicer/blob/69358596167cbc99d39acfa98a5cfa2a1e4042dd/Base/Python/sitkUtils.py#L50-L63">workaround in sitkUtils</a>. You can safely ignore the warnings.</p>
<p><a class="mention" href="/u/blowekamp">@blowekamp</a> Do you think we still need this workaround? On Windows, it does not seem to be necessary - for example, this code works:</p>
<pre><code>import SimpleITK as sitk

# Pull volume from Slicer
inputVolumeNode = getNode('MRHead')
inputVolumeNodeSceneAddress = inputVolumeNode.GetScene().GetAddressAsString("").replace('Addr=','')
inputVolumeNodeFullITKAddress = 'slicer:{0}#{1}'.format(inputVolumeNodeSceneAddress,inputVolumeNode.GetID())
sitkimage = sitk.ReadImage(inputVolumeNodeFullITKAddress)

# Process
filter = sitk.SignedMaurerDistanceMapImageFilter()
outputImage = filter.Execute(sitkimage)

# Push volume to Slicer
outputVolumeNode = slicer.mrmlScene.AddNewNodeByClass("vtkMRMLScalarVolumeNode")
outputVolumeNode.CreateDefaultDisplayNodes()
outputVolumeNodeSceneAddress = outputVolumeNode.GetScene().GetAddressAsString("").replace('Addr=','')
outputVolumeNodeFullITKAddress = 'slicer:{0}#{1}'.format(inputVolumeNodeSceneAddress,outputVolumeNode.GetID())
sitk.WriteImage(outputImage, outputVolumeNodeFullITKAddress)
slicer.util.setSliceViewerLayers(background = outputVolumeNode)</code></pre>

---

## Post #3 by @blowekamp (2018-04-16 13:34 UTC)

<p>That code appears to be added by yourself:<br>
<aside class="onebox githubcommit">
  <header class="source">
      <a href="https://github.com/Slicer/Slicer/commit/1128611e088884b8030e4b278a3c4976aaf04239" target="_blank" rel="nofollow noopener">github.com/Slicer/Slicer</a>
  </header>
  <article class="onebox-body">
    
<h4>
  <a href="https://github.com/Slicer/Slicer/commit/1128611e088884b8030e4b278a3c4976aaf04239" target="_blank" rel="nofollow noopener">ENH: Made sitkUtils API more robust</a>
</h4>

  <pre class="message" style="white-space: pre-wrap;">Methods in sitkUtils were simple and usable for simple testing, but were not robust enough
for general use:
- Referring to nodes by...</pre>

<div class="date">
  by <a href=""></a>
  on <a href="https://github.com/Slicer/Slicer/commit/1128611e088884b8030e4b278a3c4976aaf04239" target="_blank" rel="nofollow noopener">03:50AM - 11 Aug 17</a>
</div>

<div class="github-commit-stats">
  changed <strong>3 files</strong>
  with <strong>316 additions</strong>
  and <strong>56 deletions</strong>.
</div>

  </article>
  <div class="onebox-metadata">
    
    
  </div>
  <div style="clear: both"></div>
</aside>
</p>
<p>The ITK factory registration is a complicated process and likely has changed a bit since I last looked at it in Slicer so I don’t know.</p>
<p>With SimpleITK 1.1 we have added a method to get a list of the registered ITK ImageIO. This could detect if this need to happen or not.<br>
<a href="https://itk.org/SimpleITKDoxygen110/html/classitk_1_1simple_1_1ImageReaderBase.html#a6d5066467465ebff4b2bb895e7ed59d0" class="onebox" target="_blank" rel="nofollow noopener">https://itk.org/SimpleITKDoxygen110/html/classitk_1_1simple_1_1ImageReaderBase.html#a6d5066467465ebff4b2bb895e7ed59d0</a></p>

---

## Post #4 by @lassoan (2018-04-16 14:09 UTC)

<p>I’ve tried to access <a href="https://itk.org/SimpleITKDoxygen110/html/classitk_1_1simple_1_1ImageReaderBase.html#a6d5066467465ebff4b2bb895e7ed59d0">std::vector&lt;std::string&gt; itk::simple::ImageReaderBase::GetRegisteredImageIOs()</a> from Python but it did not seem to be available. Do you know if <code>std::vector&lt;std::string&gt;</code> types are supposed to be wrapped for Python in SimpleITK? (I know that VTK wrappers cannot deal with such types)</p>
<p>I just reorganized the code, the code for ensuring registration was added by <a class="mention" href="/u/hjmjohnson">@hjmjohnson</a>.</p>

---

## Post #5 by @blowekamp (2018-04-16 14:23 UTC)

<p>Currently, Slicer is using 1.0.1-ish there is a <a href="https://github.com/Slicer/Slicer/pull/929" rel="nofollow noopener">pull request to update to 1.1.0.</a>.</p>
<p>If you get SimpleITK with pip it will be there.</p>
<p>Yes the return type is <a href="https://github.com/SimpleITK/SimpleITK/blob/master/Wrapping/Common/SimpleITK_Common.i#L99" rel="nofollow noopener">wrapped</a> and <a href="https://github.com/SimpleITK/SimpleITK/blob/554c7304e108ad6c51122b28f23a57c0e722b110/Testing/Unit/sitkImageIOTests.cxx" rel="nofollow noopener">tested</a> in SimpleITK.</p>
<pre><code class="lang-auto">
In [1]: import SimpleITK as sitk

In [2]: print sitk.Version()
SimpleITK Version: 1.1.0 (ITK 4.13)
Compiled: Mar 22 2018 21:14:44


In [3]: print sitk.ImageFileReader().GetRegisteredImageIOs()
('BMPImageIO', 'BioRadImageIO', 'Bruker2dseqImageIO', 'GDCMImageIO', 'GE4ImageIO', 'GE5ImageIO', 'GiplImageIO', 'HDF5ImageIO', 'JPEGImageIO', 'LSMImageIO', 'MINCImageIO', 'MRCImageIO', 'MetaImageIO', 'NiftiImageIO', 'NrrdImageIO', 'PNGImageIO', 'StimulateImageIO', 'TIFFImageIO', 'VTKImageIO')
</code></pre>

---

## Post #6 by @lassoan (2018-04-16 20:41 UTC)

<p>Great! I’ll test Slicer with SimpleITK 1.1.0 tomorrow and if everything works then I’ll update the nightly build to use that version.</p>

---

## Post #7 by @zjx1805 (2018-04-17 02:56 UTC)

<p>Hello <a class="mention" href="/u/brhoom">@brhoom</a>, I saw your post here and thought you might be familiar with cropping volume in Python. I am wondering if you know of a way to crop a volume using ROI in 3D slicer in Python, modify the cropped volume and put it back into the original volume (at the same position). Essentially, what I am trying to do is like this</p>
<pre><code>Drag some ROI in 3D slicer
croppedVolumeNode = some_internal_cropping_function(volumeNode, roiNode)
modify the cropped volume
volumeNode.update(croppedVolumeNode) # to put it back to the original location
</code></pre>
<p>Thanks!</p>

---

## Post #8 by @brhoom (2018-04-22 18:02 UTC)

<aside class="quote no-group" data-username="zjx1805" data-post="7" data-topic="2585">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://avatars.discourse-cdn.com/v4/letter/z/f08c70/48.png" class="avatar"> zjx1805:</div>
<blockquote>
<p>I saw your post here and thought you might be familiar with cropping volume in Python</p>
</blockquote>
</aside>
<p>Sorry for the late reply. I do the cropping using only one point, the center of the cropping.  So to get the croppingBounds in my code above from a defined point:</p>
<pre><code>    spacing = inputVolume.GetSpacing()
    imgData = inputVolume.GetImageData()
    dimensions = imgData.GetDimensions() 
    size = [lengthX,lengthY,lengthZ] # defined volume dimensions    
    # Calculate lower and upper cropping bounds
    lower = [0,0,0]
    for i in range(0,3):
        lower[i] = point[i] - int((size[i]/spacing[i])/2)
    upper = [0,0,0]
    for i in range(0,3):
        upper[i] = dimensions[i] - (point[i]+int((size[i]/spacing[i])/2))
    croppingBounds = [lower,upper]
</code></pre>
<p>I think in your case, I will do the following <img src="https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<ul>
<li>create a copy of the original volume.</li>
<li>do the cropping</li>
<li>process the cropped volume.</li>
<li>convert the copied volume and the cropped volume to np arrays and replace the voxels in the first volume with the cropped one.</li>
</ul>
<p>Probably there is a better way. I am not the Slicer expert here. Also, I think it is not a good idea to ask different question in different post. I would open a new post with the new question to keep the forum organized.</p>
<p>Hope this helps.</p>

---

## Post #9 by @zjx1805 (2018-04-23 05:08 UTC)

<p>Yeah I posted a separate question in the forum. Thank you for your reply anyway!</p>

---
