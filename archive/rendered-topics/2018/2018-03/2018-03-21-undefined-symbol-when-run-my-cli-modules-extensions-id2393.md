# Undefined symbol when run my CLI modules extensions

**Topic ID**: 2393
**Date**: 2018-03-21
**URL**: https://discourse.slicer.org/t/undefined-symbol-when-run-my-cli-modules-extensions/2393

---

## Post #1 by @brhoom (2018-03-21 21:06 UTC)

<p>Operating system: Ubuntu 16<br>
Slicer version: 4.8.1<br>
Expected behavior: cli working<br>
Actual behavior: not working</p>
<p>my cli extension are not working “anymore”. I get these errors:</p>
<pre><code>undefined symbol: _ZN3itk13ProcessObject8SetInputERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEPNS_10DataObjectE
</code></pre>
<p>I tried install using the zipped file generated by make package. I also tried copy the libs to slicer related folder but I get the same error.</p>
<p>Just checked now, they  only work using Slicer-build/Slicer but not the installed binary Slicer. What should I do to make them works in the binary as they used to do.</p>

---

## Post #2 by @lassoan (2018-03-21 21:38 UTC)

<p>Your build seems to be ABI incompatible with the official Slicer build binaries.</p>
<p>If you are lucky then you may be able to create an ABI-compatible library on a different computer, if you use exactly the same build environment and libraries, but practically you can only ensure compatibility if you build Slicer core and all extensions on the same computer. It can be your computer - for private distributions; or the Slicer build machines - for public distribution.</p>

---

## Post #3 by @jcfr (2018-03-22 04:06 UTC)

<p>For reference, here is the unmangled name of the missing symbol:</p>
<pre><code class="lang-auto">$ echo "_ZN3itk13ProcessObject8SetInputERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEPNS_10DataObjectE" | c++filt 
itk::ProcessObject::SetInput(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, itk::DataObject*)
</code></pre>

---

## Post #4 by @jcfr (2018-03-22 04:17 UTC)

<p>Also, as illustrated in commit <a href="https://github.com/InsightSoftwareConsortium/ITK/commit/01580b37063ab3eeaa60a9f18068844b4d40e9f5">InsightSoftwareConsortium/ITK@01580b3</a>, the method <code>itk::ProcessObject::SetInput</code> was part of the deprecated API.</p>
<p>Worth noting that while Slicer is built against an ITK having <code>ITKV3_COMPATIBILITY</code> option <code>OFF</code>, the option <code>ITK_LEGACY_REMOVE</code> is still <code>OFF</code>.  See <a href="https://github.com/Slicer/Slicer/blob/68a09496a6b64dde7ebabaceb822c29ace7f9a20/SuperBuild/External_ITKv4.cmake#L100">here</a></p>
<p>Anticipating the transition to ITK 5.0, we will look into turning that option <code>ON</code> . This is captured in the following issue: <a href="https://issues.slicer.org/view.php?id=4522">https://issues.slicer.org/view.php?id=4522</a></p>

---

## Post #5 by @brhoom (2018-03-22 08:47 UTC)

<p>I don’t understand, what changed? the extension works before, why I have this incompatibility now with the new <a href="https://discourse.slicer.org/t/slicer-r26813-produces-4-9-lib/2379/4">build</a> that supposed to be the same as the binary 4.8.1? I thought Cmake take care of these things. I also tested with skipping <a href="https://cmake.org/Wiki/CMake_RPATH_handling" rel="nofollow noopener">RPATH</a> but I get the same error.</p>
<p>Thank Jean for the info.</p>
<p>I modify  SuperBuild/External_ITKv4.cmake  to enable make ITKV3_Compatibility. I also enabled the related module in ITKv4-build then rebuilt Slicer. After that, I rebuilt the extension but I got this error</p>
<pre><code>undefined symbol: _ZN6vtksys11SystemTools24GetFilenameLastExtensionERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE   
</code></pre>
<p>I checked it using:<br>
echo “_ZN6vtksys11SystemTools24GetFilenameLastExtensionERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE” | c++filt<br>
vtksys::SystemTools::GetFilenameLastExtension(std::__cxx11::basic_string&lt;char, std::char_traits, std::allocator &gt; const&amp;)</p>
<p>It looks there are some option I need to change in VTK?</p>

---

## Post #6 by @jcfr (2018-03-22 12:02 UTC)

<p>You should not have to modify the <code>ITKV3_Compatibility</code> option of Slicer. Instead, it should be possible to update your extension code to note use any legacy code. This is definitively the way forward.</p>
<p>How are you building your Slicer extension ?</p>
<p>Could you confirm you do something like this:</p>
<pre><code class="lang-nohighlight">mkdir my-extension-build
cd my-extension-build
cmake -DSlicer_DIR:PATH=/path/to/Slicer-Superbuild/Slicer-build  ../my-extension-src
make
</code></pre>
<p>In the <code>my-extension-build/CMakeCache.txt</code> of your extension, what is the value for <code>ITK_DIR</code> ? It should be <code>/path/to/Slicer-Superbuild/ITKv4-build</code></p>

---

## Post #7 by @brhoom (2018-03-22 14:29 UTC)

<p>You are right. I will try to update the code and rebuild again. It is just not clear why it works before and not working now.</p>
<p>I build the extension the same way you mentioned. I checked CMakeCashe.txt , ITK_DIR uses  my Slicer-build/ITKv4-build</p>
<p><strong>Update:</strong></p>
<p>I package my Slicer build using</p>
<pre><code>Slicer-build/make package  
</code></pre>
<p>I installed extensions from Slicer but it does not work. Looks like the build is incompatible as <a class="mention" href="/u/lassoan">@lassoan</a> mentioned. I rebuild again but the problem is still there.</p>
<p>What could possible gone wrong? I am using the source code for the same binary revision 4.8.1 using the same tools versions as mentioned in the instruction web-page e.g. Qt4.8.7.</p>

---

## Post #8 by @jcfr (2018-03-22 22:55 UTC)

<p>Instead of packaging and installing your extension, I suggest you backtrack and try the following:</p>
<ul>
<li>start Slicer from your build tree</li>
<li>go to Edit -&gt;  Settings -&gt; Modules, then add the paths to your module</li>
<li>restart Slicer</li>
</ul>
<p>Is the module properly loaded ?</p>

---

## Post #9 by @brhoom (2018-03-23 18:33 UTC)

<p>There is no problem with the locally built extensions and the locally Slicer. The problem is with the extensions built locally with the binary Slicer downloaded from Slicer website.</p>
<p>Today, I built Slicer in 2 different machines (Ubuntu 16).  I got the same error. So probably there is something wrong with the source or there is something installed affect the build.</p>
<p>I will make a clean install of Ubuntu 16 and try again. Is there a away to test the ABI incompatibility without building and testing the extensions?</p>

---

## Post #10 by @jcfr (2018-03-23 19:26 UTC)

<blockquote>
<p>no problem with the locally built extensions and the locally Slicer</p>
</blockquote>
<p>Great</p>
<h3><a name="p-9865-summary-1" class="anchor" href="#p-9865-summary-1" aria-label="Heading link"></a>summary</h3>
<blockquote>
<p>problem is with the extensions built locally with the binary Slicer downloaded from Slicer website</p>
</blockquote>
<p>Could you indicate which binary you downloaded (version of Slicer)</p>
<blockquote>
<p>I built Slicer in 2 different machines (Ubuntu 16). I got the same error. So probably there is something wrong with the source or there is something installed affect the build.</p>
</blockquote>
<p>To clarify, you build locally Slicer on two different machine:</p>
<ul>
<li>local machine 1 (Ubuntu 16)</li>
<li>local machine 2 (Ubuntu 16)</li>
</ul>
<p>Then, you locally built your extension on machine 1 and created a package from it (using <code>make package</code>)</p>
<p>Finally, you copied the packaged created on machine 1 onto machine 2.</p>
<p>Installed the extension using the <a href="https://www.slicer.org/wiki/Documentation/Nightly/SlicerApplication/ExtensionsManager#Installing_an_extension_without_network_connection">install extension from file</a></p>
<p>And you see the error at startup on machine 2 ?</p>
<h3><a name="p-9865-questions-2" class="anchor" href="#p-9865-questions-2" aria-label="Heading link"></a>questions</h3>
<p>It may be useful to try running the application setting the <code>LD_DEBUG</code> env variable. See <a href="https://linux.die.net/man/8/ld.so">https://linux.die.net/man/8/ld.so</a> and <a href="http://www.bnikolic.co.uk/blog/linux-ld-debug.html" class="inline-onebox">The LD_DEBUG environment variable | B. Nikolic Software and Computing Blog</a></p>
<p>Do you have itk locally installed on any of the machine ?</p>
<p>What is the value of <code>LD_LIBRARY_PATH</code> ? Do you have any custom <code>ld.conf</code> settings ? (see file <code>/etc/ld.so.conf</code> or directory <code>/etc/ld.so.conf.d/</code>)</p>
<h3><a name="p-9865-abi-checker-3" class="anchor" href="#p-9865-abi-checker-3" aria-label="Heading link"></a>abi checker</h3>
<blockquote>
<p>Is there a away to test the ABI incompatibility</p>
</blockquote>
<p>This project could be useful, but I don’t think it will help yet: <a href="https://sourceware.org/glibc/wiki/Testing/ABI_checker" class="inline-onebox">Making sure you're not a bot!</a></p>
<h3><a name="p-9865-moving-forward-4" class="anchor" href="#p-9865-moving-forward-4" aria-label="Heading link"></a>moving forward</h3>
<p>To help with reproducing build, we are currently transitioning our linux build to use:</p>
<aside class="onebox githubrepo" data-onebox-src="https://github.com/dockbuild/dockbuild">
  <header class="source">

      <a href="https://github.com/dockbuild/dockbuild" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <div class="github-row" data-github-private-repo="false">
  <img width="690" height="344" src="https://opengraph.githubassets.com/81ae123c3173df6e9b15e83683b2b56d/dockbuild/dockbuild" class="thumbnail">

  <h3><a href="https://github.com/dockbuild/dockbuild" target="_blank" rel="noopener">GitHub - dockbuild/dockbuild: Compiling environments in Docker images.</a></h3>

    <p><span class="github-repo-description">Compiling environments in Docker images.</span></p>
</div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>This will allow anyone to re-produce the build locally.</p>

---

## Post #11 by @brhoom (2018-03-23 21:21 UTC)

<p><a class="mention" href="/u/jcfr">@jcfr</a> many thanks for your concern.</p>
<blockquote>
<p>Could you indicate which binary you downloaded (version of Slicer)</p>
</blockquote>
<p>The stable version. <a href="https://download.slicer.org/bitstream/738960" rel="noopener nofollow ugc">Slicer 4.8.1 r26813</a>. I thought by building the source of the same revision in release mode,  I will get a compatible build.</p>
<blockquote>
<p>To clarify …</p>
</blockquote>
<p>Everything is as you mentioned expect I am trying to run the locally build extension using the downloaded binary above.</p>
<p>In each machine I did:</p>
<ul>
<li>build Slicer r26813 in release mode.</li>
<li>build the extension in release mode using the same build and packaged it.</li>
<li>downloaded Slicer 4.8.1 and install the plugin using “install from a file” method.</li>
<li>When I run the extension the error “undefined symbol”  appeared.</li>
</ul>
<blockquote>
<p>Do you have itk locally installed on any of the machine ?</p>
</blockquote>
<p>All the machines has ITK locally build and installed (in addition to the one in Slicer superbuild).</p>
<blockquote>
<p>It may be useful to try running the application setting the LD_DEBUG env variable.</p>
</blockquote>
<p>Running LD_DEBUG=symbol ~/mySlicerBinaryPath/Slicer – launch ./my_cli  some_argument 2&gt; LD_DEBUG_Output.txt  produced thousands of lines,  large part of the output is missing in the txt file.</p>
<blockquote>
<p>What is the value of LD_LIBRARY_PATH ?</p>
</blockquote>
<p>$ echo $LD_LIBRARY_PATH<br>
:/usr/local/cuda-9.0/lib64:/usr/local/lib:~/sw/qt5.7.0/5.7/gcc_64/lib</p>
<blockquote>
<p>Do you have any custom ld.conf settings ?</p>
</blockquote>
<p>I think I don’t have any custom ld.conf setting.</p>
<blockquote>
<p>abi checker<br>
moving forward, dockbuild - Compiling environments in Docker images.</p>
</blockquote>
<p>This would be very nice to have.</p>

---

## Post #12 by @brhoom (2018-03-24 08:15 UTC)

<p><strong>Update:</strong></p>
<p>The problem is still there even after clean install of Ubuntu 16. I installed a new Ubuntu 16 in a virtualbox and run this script to build Slicer:</p>
<pre><code># Preare build tree 
mkdir ~/sw
mkdir ~/sw/Slicer4.8.1-dev
mkdir ~/sw/Slicer4.8.1-dev/build

# Install necessary tools 
sudo apt -y update &amp;&amp; sudo apt upgrade  &amp;&amp; sudo apt-get install subversion git-core git-svn make gcc g++ libx11-dev libxt-dev libgl1-mesa-dev libglu1-mesa-dev libfontconfig-dev libxrender-dev libncurses5-dev curl libssl-dev  

#install qt4
sudo apt -y install qt4-dev-tools libqt4-dev libqtcore4 libqtgui4 libqtwebkit-dev

# Download and install CMake3.11
wget -N  https://cmake.org/files/v3.11/cmake-3.11.0-rc4.tar.gz  -P ~/sw  &amp;&amp; tar -xzvf ~/sw/cmake-3.11.0-rc4.tar.gz  -C ~/sw

cd ~/sw/cmake-3.11.0-rc4
./bootstrap  &amp;&amp;  make &amp;&amp;  sudo make install 

#Download build Slicer
cd ~/sw/
svn co http://svn.slicer.org/Slicer4/branches/Slicer-4-8  ~/sw/Slicer4.8.1-dev/src -r 26813 &amp;&amp; 
cd ~/sw/Slicer4.8.1-dev/build
cmake -DCMAKE_BUILD_TYPE=Release  ~/sw/Slicer4.8.1-dev/src &amp;&amp; make 
</code></pre>
<p>I tried in two different Ubuntu 16 machines, their build are compatible with each other but not with the one from Slicer download:</p>
<ul>
<li>Machine 1 has M1Slicer-build (the build folder for Slicer) and M1Slicer-bin (the Slicer binary package generated from the build)</li>
<li>Machine 2 has M2Slicer-build and M2Slicer-bin</li>
<li>I copied M1Slicer-bin to Machine 2 and  copied MSlicer-bin to Machine 1</li>
<li>In Machine 1: I can build an extension using  M1Slicer-build and install it and run it in the copied M1Slicer-bin</li>
<li>Same goes for Machine 2.</li>
</ul>
<p>Is there something I did wrong? does using cmake 3.11 make difference? or maybe Ubuntu 16 is not compatible with the Slicer Linux binary I downloaded?</p>

---

## Post #13 by @brhoom (2018-03-27 19:05 UTC)

<p><strong>Update</strong><br>
Tried a Slicer build using <a href="https://github.com/jcfr/qt-easy-build" rel="noopener nofollow ugc">qt4t easy</a>. I tested after the build, still not compatible.</p>
<p>If anyone was able to build a compatible Slicer version in Ubuntu 16.04,  I would like to know how he did it.</p>
<p>I think the source is not the same.  I noticed there is a small change in the “about window” (one has the date in the second line while the other has not). As I have number of ITK extensions don’t work, probably the ITK version or the ITK configuration is different?<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/d/3/d3963ac0fd58ad5c51c03a778b43847ef19c5396.png" data-download-href="/uploads/short-url/ubMBUBuRjTg69DjkGAPXwy4kvlA.png?dl=1" title="SlicerBuild" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/d/3/d3963ac0fd58ad5c51c03a778b43847ef19c5396_2_690x474.png" alt="SlicerBuild" data-base62-sha1="ubMBUBuRjTg69DjkGAPXwy4kvlA" width="690" height="474" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/d/3/d3963ac0fd58ad5c51c03a778b43847ef19c5396_2_690x474.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/d/3/d3963ac0fd58ad5c51c03a778b43847ef19c5396.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/d/3/d3963ac0fd58ad5c51c03a778b43847ef19c5396.png 2x" data-dominant-color="E6E6E8"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">SlicerBuild</span><span class="informations">882×606 110 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p><a class="mention" href="/u/jcfr">@jcfr</a> <a class="mention" href="/u/lassoan">@lassoan</a> : could you please comment or suggest?</p>

---

## Post #14 by @jcfr (2018-03-29 05:38 UTC)

<blockquote>
<p>one has the date in the second line while the other has not</p>
</blockquote>
<p>This is normal, to build a release that do not include the date, you would have to set the option <code>-DSlicer_RELEASE_TYPE:STRING=Stable</code>. See <a href="https://www.slicer.org/wiki/Documentation/Nightly/Developers/ReleaseProcess#Day_1:_Release">ReleaseProcess</a> checklist.</p>
<p>But the impact is only cosmetic.</p>
<blockquote>
<p>If anyone was able to build a compatible Slicer</p>
</blockquote>
<p>You can <strong>not</strong> build extension using Ubuntu 16.04 and expect them to be compatible with the Slicer 4.8.1 release.</p>
<p>Indeed, the Slicer 4.8.1 release was done using Ubuntu 10.04.</p>
<p>Considering it is not possible to install such an old distribution, there is we now docker images allowing to reproduce builds.</p>
<p>Following this guide will allow you to build your extension and have it working with the Slicer 4.8.1 Linux release.</p>
<p>See <a href="https://discourse.slicer.org/t/introducing-slicerbuildenvironment-project/2465#heading--step-by-step-1" class="inline-onebox">Introducing SlicerBuildEnvironment project</a></p>

---

## Post #15 by @brhoom (2018-03-29 06:49 UTC)

<aside class="quote no-group" data-username="jcfr" data-post="14" data-topic="2393">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/jcfr/48/17825_2.png" class="avatar"> jcfr:</div>
<blockquote>
<p>ng Ubuntu 10.04.</p>
</blockquote>
</aside>
<p>Now I understand, thanks for the comment.</p>
<p>Why not using the last stable Ubuntu i.e. 16.04 instead of Ubuntu 10.04? with the script above, I was able to build Slicer without any problem in different machines including virtualbox machine. I will try the docker approach as well.</p>

---

## Post #16 by @jcfr (2018-03-29 06:54 UTC)

<aside class="quote no-group" data-username="brhoom" data-post="15" data-topic="2393">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/brhoom/48/1228_2.png" class="avatar"> brhoom:</div>
<blockquote>
<p>Why not using the last stable Ubuntu i.e. 16.04 instead of Ubuntu 10.04?</p>
</blockquote>
</aside>
<p>To ensure the generated binaries can run a broad set of linux distribution, it is important to use an older distribution requiring an older version of GLIBC and GLIBCXX .</p>
<p>For the upcoming release depending on qt5, we will use centos7</p>
<aside class="quote no-group" data-username="brhoom" data-post="15" data-topic="2393">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/brhoom/48/1228_2.png" class="avatar"> brhoom:</div>
<blockquote>
<p>. I will try the docker approach as well.</p>
</blockquote>
</aside>
<p>Great. Wait until tomorrow, updated images are being generated and should be available on dockerhub shortly. The current <code>ubuntu1004-gcc4</code> has gcc version 4.4.3 but Slicer binaries were generated with gcc 4.6. See <a href="https://www.slicer.org/wiki/Documentation/Nightly/Developers/Factory#factory-south-ubuntu.kitware">here</a></p>

---

## Post #17 by @jcfr (2018-03-29 09:05 UTC)

<aside class="quote no-group" data-username="jcfr" data-post="16" data-topic="2393">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/jcfr/48/17825_2.png" class="avatar"> jcfr:</div>
<blockquote>
<p>Wait until tomorrow, updated images are being generated</p>
</blockquote>
</aside>
<p>Updated docker images are now available.</p>

---

## Post #18 by @brhoom (2018-03-30 11:20 UTC)

<p>I just tried it, it was some how complicated because I am trying to get the concept of the docker and there was was some problems regarding permissions and c++ code in my extensions  but finally it works now <img src="https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=5" title=":slight_smile:" class="emoji" alt=":slight_smile:"> . Thanks for your effort.</p>
<p>I hope, I am not asking too much <img src="https://emoji.discourse-cdn.com/twitter/grin.png?v=5" title=":grin:" class="emoji" alt=":grin:">  maybe in the future, it is much simpler if you provide an actual build of some popular Linux systems using the recent stable version as everything can be done automatically via scripting. Some download statistics can help in deciding this based on which operating systems the downloaders use.</p>

---
