# Crash in python wrapped MRML node on load during enum iterating

**Topic ID**: 3221
**Date**: 2018-06-18
**URL**: https://discourse.slicer.org/t/crash-in-python-wrapped-mrml-node-on-load-during-enum-iterating/3221

---

## Post #1 by @adamrankin (2018-06-18 20:07 UTC)

<p>Hello all,</p>
<p>I am experience a crash with a tp_dict is NULL but being accessed when <code>PyvtkMRMLCameraNode_ClassNew</code> is being called.</p>
<p>Code:</p>
<pre><code class="lang-auto">PyObject *d = pytype-&gt;tp_dict;
  PyObject *o;

  for (int c = 0; c &lt; 2; c++)
  {
    static const struct { const char *name; int value; }
      constants[2] = {
        { "IntrinsicsModifiedEvent", vtkMRMLCameraNode::IntrinsicsModifiedEvent },
        { "DistortionCoefficientsModifiedEvent", vtkMRMLCameraNode::DistortionCoefficientsModifiedEvent },
      };

    o = PyInt_FromLong(constants[c].value);
    if (o)
    {
      PyDict_SetItemString(d, constants[c].name, o); **&lt;-- crash here, d is NULL**
      Py_DECREF(o);
    }
  }
</code></pre>
<p>Commenting out the offending line allows Slicer to load as expected with module loaded.</p>
<p>Has anyone seen this before?</p>
<p>Adam</p>

---

## Post #2 by @lassoan (2018-06-18 22:10 UTC)

<p>I don’t remember seeing this error, but the behavior of the application is undefined if you perform any operations before application’s startupCompleted signal is emitted.</p>
<p>Can you send a link to the source code line that triggers the error?</p>

---

## Post #3 by @ihnorton (2018-06-19 02:54 UTC)

<aside class="quote no-group" data-username="adamrankin" data-post="1" data-topic="3221">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/adamrankin/48/155_2.png" class="avatar"> adamrankin:</div>
<blockquote>
<p>Commenting out the offending line allows Slicer to load as expected with module loaded.</p>
</blockquote>
</aside>
<p>But, presumably, without those enums actually exposed to Python?</p>
<p>I guess those are new enums, added to the class header, because I don’t see them in current trunk. So it would be worth comparing the code generated for other enums in the same class, or in similar generated vtk*Python.cxx classes under Slicer-build. There are many other enums in that class (for example:  <code>::Direction</code>) which should have exactly the same pattern and crash in the same way if .tp_dict is not initialized. The line near the top of vtkX_ClassNew that contains <code>if ((pytype-&gt;tp_flags &amp; Py_TPFLAGS_READY) != 0) {return...}</code> is supposed to guard against uninitialized fields like this.</p>

---

## Post #4 by @adamrankin (2018-06-19 15:27 UTC)

<p><a class="mention" href="/u/lassoan">@lassoan</a> I can’t, as it’s in the autogenerated python cxx.</p>
<p>The line that crashes is this one:</p>
<pre><code class="lang-c++">PyDict_SetItemString(d, constants[c].name, o);
</code></pre>
<p><a class="mention" href="/u/ihnorton">@ihnorton</a> yes, correct, without being able to access the enum (I needed to test other code, so it was a temporary workaround).</p>
<p>It is not new (via commits), but it’s the first time I’ve tried to load the extension in Slicer, so in that sense it’s new.</p>
<p>I am going to compare against other MRML node types and try to figure out how mine is different (which was also <a class="mention" href="/u/cpinter">@cpinter</a>’s suggestion).</p>
<p>Edit: I’ve commited the latest code</p><aside class="onebox allowlistedgeneric" data-onebox-src="https://github.com/VASST/SlicerPinholeCameras">
  <header class="source">
      <img src="https://github.githubassets.com/favicons/favicon.svg" class="site-icon" width="32" height="32">

      <a href="https://github.com/VASST/SlicerPinholeCameras" target="_blank" rel="noopener nofollow ugc">GitHub</a>
  </header>

  <article class="onebox-body">
    <div class="aspect-image" style="--aspect-ratio:690/345;"><img src="https://opengraph.githubassets.com/f113c88073970f5c539974a12502f58562578e413a00d857ab3a97318f1d32d6/VASST/SlicerPinholeCameras" class="thumbnail" width="690" height="345"></div>

<h3><a href="https://github.com/VASST/SlicerPinholeCameras" target="_blank" rel="noopener nofollow ugc">GitHub - VASST/SlicerPinholeCameras: An extension for interacting,...</a></h3>

  <p>An extension for interacting, calibrating, and using cameras in Slicer - GitHub - VASST/SlicerPinholeCameras: An extension for interacting, calibrating, and using cameras in Slicer</p>


  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>


---

## Post #5 by @ihnorton (2018-06-19 15:56 UTC)

<aside class="quote no-group" data-username="adamrankin" data-post="4" data-topic="3221">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/adamrankin/48/155_2.png" class="avatar"> adamrankin:</div>
<blockquote>
<p>It is not new (via commits)</p>
</blockquote>
</aside>
<p>Oh, I was looking at the class by the same name in core:</p>
<ul>
<li><a href="https://github.com/Slicer/Slicer/blob/master/Libs/MRML/Core/vtkMRMLCameraNode.h" class="inline-onebox">Slicer/Libs/MRML/Core/vtkMRMLCameraNode.h at main · Slicer/Slicer · GitHub</a></li>
</ul>
<p>That might be the problem… Maybe a race condition in the initialization where the core object of the same name is created already but not “finalized”, and your initializer crashes trying to use it?</p>
<p>(did you just add BTX around the enums <a href="https://github.com/VASST/SlicerCamera/blob/master/Camera/MRML/vtkMRMLCameraNode.h#L32-L38">here</a> to fix the crash temporarily?)</p>

---

## Post #6 by @adamrankin (2018-06-19 15:56 UTC)

<p>Aaahhahaha.</p>
<p>So, we don’t need to talk about it, but did you guys know that there’s a vtkMRMLCameraNode in the core?</p>

---

## Post #7 by @adamrankin (2018-06-19 18:32 UTC)

<p>So, that was obviously one issue, but I’m still having a crash. Somehow vtkMRMLWebcamNode has already been initialized, so it’s found in the class map, so tp_dict is never new’d.</p>
<pre><code class="lang-auto">PyVTKClass *PyVTKClass_Add(
  PyTypeObject *pytype, PyMethodDef *methods,
  const char *classname, vtknewfunc constructor)
{
  // Add this type to the vtk class map
  PyVTKClass *info =
    vtkPythonUtil::AddClassToMap(
      pytype, methods, classname, constructor);

  if (info == nullptr)
  {
    // The class was already in the map, so do nothing
    return info;
  }

  // Cache the type object for vtkObjectBase for quick access
  if (PyVTKObject_Type == nullptr &amp;&amp; strcmp(classname, "vtkObjectBase") == 0)
  {
    PyVTKObject_Type = pytype;
  }

  // Create the dict
  if (pytype-&gt;tp_dict == nullptr)
  {
    pytype-&gt;tp_dict = PyDict_New();
  }
</code></pre>
<p>info is always null, even if this is the first time my code gets hit. Investigating further.</p>

---

## Post #8 by @ihnorton (2018-06-19 18:41 UTC)

<p>One thing that sticks out to me is that the enums are declared as the very first members in the class (as the code currently appears on github). I think most Slicer classes have the static constructor and vtkTypeMacro stuff first. The wrapper-generator might be generating some initialization stanza out of order (it seems to be very straight-line codegen, not really contextual).</p>

---

## Post #9 by @adamrankin (2018-06-19 18:43 UTC)

<p>I think it’s a clean-build issue. Deleted folder of old naming convention, cleared symbol cache in VS, see if it works.</p>

---
