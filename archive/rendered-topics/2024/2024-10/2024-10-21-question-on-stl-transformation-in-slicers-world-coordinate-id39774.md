# Question on STL transformation in slicer's world coordinate

**Topic ID**: 39774
**Date**: 2024-10-21
**URL**: https://discourse.slicer.org/t/question-on-stl-transformation-in-slicers-world-coordinate/39774

---

## Post #1 by @alientex (2024-10-21 12:18 UTC)

<p>Hello,</p>
<p>First, I created a segment and converted it into a model in slicer.</p>
<p>Second, I have written an external script purely based on VTK, which does not rely on Slicer classes. The script reads DICOM files using <code>vtkDICOMImageReader</code>, applies a threshold using <code>vtkImageThreshold</code>, converts it to a model using VTK’s marching cubes, and finally exports it using <code>vtkSTLWriter</code>.</p>
<p>Now, I imported the STL generated by the script, into Slicer to compare it against the model generated earlier from the segment. However, I am unable to compare their contours in 2D because my external STL is not aligned with the model generated by Slicer. In the 3D scene, both models are far apart and do not lie on the same origin. I don’t want to use the Transform module because of its manual nature. I want to simulate, how slicer internally does transformations, within my script so that when I export any STL from my script and import it into Slicer, it has the correct transformations and aligns with the 3D Slicer-generated model.</p>

---

## Post #2 by @pieper (2024-10-21 13:13 UTC)

<p><a href="https://slicer.readthedocs.io/en/latest/user_guide/coordinate_systems.html" class="onebox" target="_blank" rel="noopener">https://slicer.readthedocs.io/en/latest/user_guide/coordinate_systems.html</a></p>

---

## Post #3 by @alientex (2024-10-21 16:03 UTC)

<p>Thank you for providing the reference.</p>
<p>I have gone through it, and I was wondering how I can utilize the exact transformation matrix of Slicer. I am setting the labelmap’s origin and spacing to be the same as the one given in the <code>CreateClosedSurface</code> function of the <code>vtkBinaryLabelmapToClosedSurfaceConversionRule</code> class.</p>
<p>I’ve been stuck on this problem for many days. I would appreciate further help.</p>
<p>Here’s a picture of the models for reference (the green model is from Slicer, and the yellow one is generated from the script):<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/3/2/32f5786bdf4f71157bf7c025169088d49487e033.png" data-download-href="/uploads/short-url/7gNN4dDpfjOgywgu1edoyi5IP0T.png?dl=1" title="image" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/3/2/32f5786bdf4f71157bf7c025169088d49487e033.png" alt="image" data-base62-sha1="7gNN4dDpfjOgywgu1edoyi5IP0T" width="244" height="184"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">326×246 8.46 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>Thank you.</p>

---

## Post #4 by @pieper (2024-10-21 16:31 UTC)

<p>My guess is that you just need to pick LPS on loading like this:</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/9/9/9942f3967a04e3d919d25dcf09e9670ef3813736.png" data-download-href="/uploads/short-url/lROuKnQ6d1E4FKpMZqqGAzpftxc.png?dl=1" title="image"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/9/9942f3967a04e3d919d25dcf09e9670ef3813736_2_690x240.png" alt="image" data-base62-sha1="lROuKnQ6d1E4FKpMZqqGAzpftxc" width="690" height="240" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/9/9/9942f3967a04e3d919d25dcf09e9670ef3813736_2_690x240.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/9/9/9942f3967a04e3d919d25dcf09e9670ef3813736.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/9/9/9942f3967a04e3d919d25dcf09e9670ef3813736.png 2x" data-dominant-color="EAEBEC"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">930×324 30.2 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>If that’s it and you want to make this automatic in the future you can add a coordinate system tag in the stl header something like this:</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/Slicer/Slicer/blob/0fe633e6a86ac1c4ed95a7afd6a35ead81e83b84/Libs/MRML/Core/vtkMRMLModelStorageNode.cxx#L614">
  <header class="source">

      <a href="https://github.com/Slicer/Slicer/blob/0fe633e6a86ac1c4ed95a7afd6a35ead81e83b84/Libs/MRML/Core/vtkMRMLModelStorageNode.cxx#L614" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/Slicer/Slicer/blob/0fe633e6a86ac1c4ed95a7afd6a35ead81e83b84/Libs/MRML/Core/vtkMRMLModelStorageNode.cxx#L614" target="_blank" rel="noopener">Slicer/Slicer/blob/0fe633e6a86ac1c4ed95a7afd6a35ead81e83b84/Libs/MRML/Core/vtkMRMLModelStorageNode.cxx#L614</a></h4>



    <pre class="onebox"><code class="lang-cxx">
      <ol class="start lines" start="604" style="counter-reset: li-counter 603 ;">
          <li>}</li>
          <li>else if (extension == ".stl")</li>
          <li>{</li>
          <li>  vtkNew&lt;vtkTriangleFilter&gt; triangulator;</li>
          <li>  vtkNew&lt;vtkSTLWriter&gt; writer;</li>
          <li>  this-&gt;GetUserMessages()-&gt;SetObservedObject(writer);</li>
          <li>  writer-&gt;SetFileName(fullName.c_str());</li>
          <li>  writer-&gt;SetFileType(this-&gt;GetUseCompression() ? VTK_BINARY : VTK_ASCII );</li>
          <li>  triangulator-&gt;SetInputData(meshToWrite);</li>
          <li>  writer-&gt;SetInputConnection(triangulator-&gt;GetOutputPort());</li>
          <li class="selected">  std::string header = std::string("3D Slicer output. ") + coordinateSytemSpecification;</li>
          <li>  writer-&gt;SetHeader(header.c_str());</li>
          <li>  try</li>
          <li>  {</li>
          <li>    success = success &amp;&amp; writer-&gt;Write();</li>
          <li>  }</li>
          <li>  catch (...)</li>
          <li>  {</li>
          <li>    success = false;</li>
          <li>  }</li>
          <li>  this-&gt;GetUserMessages()-&gt;SetObservedObject(nullptr);</li>
      </ol>
    </code></pre>



  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p><a href="https://slicer.readthedocs.io/en/v4.11/user_guide/data_loading_and_saving.html#models" class="onebox" target="_blank" rel="noopener">https://slicer.readthedocs.io/en/v4.11/user_guide/data_loading_and_saving.html#models</a></p>

---

## Post #5 by @alientex (2024-10-22 03:47 UTC)

<p>Hello <a class="mention" href="/u/pieper">@pieper</a> ,</p>
<p>I tried loading the STL by selecting both coordinate systems, but it didn’t work, as the result is still the same. I also modified my script to include the coordinate tag, and when I loaded the STL again, there was no luck.</p>
<p>Here’s my code for saving a mesh:</p>
<pre><code class="lang-auto">def SaveMeshToSTL(polydata, filename):
    stl_writer = vtk.vtkSTLWriter()
    stl_writer.SetFileName(filename)

    stl_writer.SetInputData(polydata)

    coordinateSystemTag = "SPACE"
    CoordinateSystem = slicer.vtkMRMLModelStorageNode().CoordinateSystemLPS
    coordinateSystemStr = slicer.vtkMRMLModelStorageNode().GetCoordinateSystemTypeAsString(CoordinateSystem)
    coordinateSytemSpecification = coordinateSystemTag + "=" + coordinateSystemStr
    header = "3D Slicer output. " + coordinateSytemSpecification
    stl_writer.SetHeader(header)

    stl_writer.SetFileType(vtk.VTK_BINARY)

    stl_writer.Write()
    print(f"Model successfully saved to {filename}")
</code></pre>
<p>The output of the function <code>TransformIJKToWorld</code> is then passed to the mesh-saving function as polydata:</p>
<pre><code class="lang-auto">def TransformIJKToWorld(polydata, oriented_data):
    labelmapGeometryTransform = vtk.vtkTransform()
    labelmapImageToWorldMatrix = vtk.vtkMatrix4x4()

    oriented_data.GetImageToWorldMatrix(labelmapImageToWorldMatrix)
    labelmapGeometryTransform.SetMatrix(labelmapImageToWorldMatrix)

    transformPolyDataFilter = vtk.vtkTransformPolyDataFilter()
    transformPolyDataFilter.SetInputData(polydata)
    transformPolyDataFilter.SetTransform(labelmapGeometryTransform)
    transformPolyDataFilter.Update()

    return transformPolyDataFilter.GetOutput()
</code></pre>
<p><a class="mention" href="/u/lassoan">@lassoan</a> <a class="mention" href="/u/cpinter">@cpinter</a> <a class="mention" href="/u/muratmaga">@muratmaga</a>, Any idea what might be the issue?</p>

---

## Post #6 by @pieper (2024-10-22 12:06 UTC)

<p>Well, it must be something else then.  You just need to trace through all the matrices and coordinates to validate your assumptions.</p>

---

## Post #7 by @lassoan (2024-10-22 13:09 UTC)

<p>vtkDICOMImageReader only works for special cases. I would not recommend spending any time with trying to debug why the image is not loaded correctly with vtkDICOMImageReader. If you are looking for a pure VTK-based solution then your best option is <a href="https://github.com/dgobbi/vtk-dicom/" class="inline-onebox">GitHub - dgobbi/vtk-dicom: A set of classes for using DICOM in VTK.</a>. It is still very limited but works for majority of basic image acquisitions. Make sure you take into account the <code>PatientMatrix</code> provided by the reader.</p>
<p>If you want to reconstruct volumes from more complex acquisitions then you can use dcm2niix or Slicer. If you want an open-source solution to read not just images but other important DICOM objects then probably your only choice is Slicer (or implement yourself from pydicom level).</p>

---

## Post #8 by @alientex (2024-10-25 03:18 UTC)

<p><a class="mention" href="/u/lassoan">@lassoan</a>, your suggested solution really worked! I used the <code>PatientMatrix</code> from <code>vtkDICOMReader</code>, and it’s giving me correct results now.</p>
<p>Thank you!</p>

---
