# Extract centerline curves in two disconnected branches

**Topic ID**: 34135
**Date**: 2024-02-03
**URL**: https://discourse.slicer.org/t/extract-centerline-curves-in-two-disconnected-branches/34135

---

## Post #1 by @ruili (2024-02-03 16:10 UTC)

<p>Hi! I have been using the ExtractCenterline module in 3D slicer to extract centerlines in a vessel structure. The original segmentation that I have has a small part of a large vessel, from which multiple branches of small vessels stem. As I only want to extract centerlines in the small vessels, and I want to ensure that the endpoints or branching points are completely inside the small vessels, I manually defined the endpoints (“final_endpoints_15/16”) from which the centerlines should grow. After running the algorithm, I found that the centerline model (thick green lines) is correct, but the centerline curves were only extracted for one branch. Is there any way to extract the curves in the other branch as well? Thanks!<br>
<div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/c/e/ce1d6957cccfdc40465707e6c66ef772fd536c81.jpeg" data-download-href="/uploads/short-url/tpnn6ReVFlraTvzxh9MZlKTAe41.jpeg?dl=1" title="Screenshot 2024-02-03 at 15.52.08" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/c/e/ce1d6957cccfdc40465707e6c66ef772fd536c81_2_690x447.jpeg" alt="Screenshot 2024-02-03 at 15.52.08" data-base62-sha1="tpnn6ReVFlraTvzxh9MZlKTAe41" width="690" height="447" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/c/e/ce1d6957cccfdc40465707e6c66ef772fd536c81_2_690x447.jpeg, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/c/e/ce1d6957cccfdc40465707e6c66ef772fd536c81_2_1035x670.jpeg 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/c/e/ce1d6957cccfdc40465707e6c66ef772fd536c81_2_1380x894.jpeg 2x" data-dominant-color="B6B9D5"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot 2024-02-03 at 15.52.08</span><span class="informations">1616×1047 281 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>

---

## Post #2 by @ruili (2024-02-07 11:20 UTC)

<p>Hi! <a class="mention" href="/u/mikebind">@mikebind</a> <a class="mention" href="/u/lassoan">@lassoan</a> I was wondering if you guys or other experts have any thoughts on this question?</p>

---

## Post #3 by @mikebind (2024-02-07 16:54 UTC)

<p>I don’t have experience working with much with branching trees with VMTK. However, could you just run the analysis twice, once with final-endpoints-16 as the source and F-10, F-11, and F-12 as the endpoints and then once with final-endpoints-15 as the source and the rest of the tips as endpoints?</p>
<p>I believe <a class="mention" href="/u/chir.set">@chir.set</a> is an expert VMTK user, perhaps they can weigh in?</p>

---

## Post #4 by @chir.set (2024-02-07 17:57 UTC)

<p>Do ‘final_endpoints-x’ and ‘F-x’ belong to the same point list?</p>
<p>It seems that the centeline model(s) have been generated from 2 different point lists. If ‘final_endpoints-x’ and ‘F-x’ belong to the same point list, ‘final_endpoints-15’ and ‘final_endpoints-16’ should have been connected by the centerline.</p>
<p>Curves are generated by ‘Extract centerline’ as a consequence of the centerline model. If the left centerline tree has been generated independently from the the right centerline tree, are you meaning that ‘Extract centeline’ created centerline curves for the right tree and not for the left? Please clarify the steps that led to this image.</p>
<p>For simplicity, I would have created a point list for the right tree well identified by consistent labels, a second one for the left one, and process them separately.</p>
<p>Can you share the data as an MRB file?</p>

---

## Post #5 by @ruili (2024-02-15 17:53 UTC)

<p>The forum does not allow me to upload an MRB file, so I’ve saved the scene as an MRB file and uploaded <a href="https://drive.google.com/file/d/1eTTquFSzlJC8Ioq7qHEl590RjKiD5uNs/view?usp=sharing" rel="noopener nofollow ugc">here</a>.</p>
<blockquote>
<p>Please clarify the steps that led to this image</p>
</blockquote>
<p>I created this segmentation and the ‘F-x’ endpoints using my own script outside Slicer and loaded them into this scene. The two ‘final_endpoints-x’ endpoints were then added manually on Slicer. Because when I created the ‘F-x’ endpoints I named the points as ‘F-x’ but saved them as ‘final_endpoints.json’, when I added two more endpoints on slicer to the same list, they were automatically named as ‘final_endpoints-x’. Therefore, to answer your question, <strong>‘final_endpoints-x’ and ‘F-x’ do belong to the same point list</strong>.</p>
<p>After manually placing the two extra endpoints, I toggle selected them as source (thus they appear blue), and I used the ExtractCenterline module to extract the centerline model and centerline curves. The left centerline tree and the right centerline tree were generated at the same time, and on the ‘subject hierarchy’ panel they belong to the same node named ‘centerline model’. I don’t know why they were not connected as you said they should – possibly because I selected two endpoints as source?</p>
<p>However, after generating the centerline model, the centerline curves were only extracted for the right tree. Hence the question that I posted.</p>
<p>It will certainly work if I define the endpoints for the left and right trees in two separate endpoint lists. However, I want to automate the endpoint detection as much as possible as I need to repeat similar procedure for many files, and since the branches all belong to the same segment, running automatic endpoint detection will simply get all the endpoints at once without distinguishing which one is in which branch. Thus, I was hoping that I can just manually place the two source endpoints at the bottom and grow the centerline model and curves upwards. The current ‘centerline model’ is already exactly the centerline structure that I want to extract. It’s just that the curves were not extracted fully.</p>
<p>Another alternative approach that I’ve tried is to split the segmentation first (detach the two branches from the base) and then run automatic endpoint detection and centerline extraction. This can work, but the user still needs to cut the segmentation, check the endpoints, select source endpoint… so it’s more tedious than my original approach where the manual part is just placing two endpoints.</p>
<p>I hope my explanation makes sense. I look forward to hearing your thoughts.</p>

---

## Post #6 by @chir.set (2024-02-16 11:06 UTC)

<p>After simply activating ‘final_endpoints-x’ in the Markups module’s widget, ‘Extract centerline’ generated the model and the curve centerlines as expected.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/b/4/b4c297021d020cbdbeaaa0e54ebf88230f12bd80.png" data-download-href="/uploads/short-url/pN4QNqm0e74Zt8H98s0t6lLaRji.png?dl=1" title="activate_all_points" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/b/4/b4c297021d020cbdbeaaa0e54ebf88230f12bd80_2_420x500.png" alt="activate_all_points" data-base62-sha1="pN4QNqm0e74Zt8H98s0t6lLaRji" width="420" height="500" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/b/4/b4c297021d020cbdbeaaa0e54ebf88230f12bd80_2_420x500.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/b/4/b4c297021d020cbdbeaaa0e54ebf88230f12bd80.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/b/4/b4c297021d020cbdbeaaa0e54ebf88230f12bd80.png 2x" data-dominant-color="121711"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">activate_all_points</span><span class="informations">497×591 112 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>
<p>As to why the activated state of control points matters, <a class="mention" href="/u/lassoan">@lassoan</a> may have some explanations. But really, just activate them.</p>

---

## Post #7 by @ruili (2024-02-16 12:13 UTC)

<p>I see. Thanks a lot! My understanding based on some tutorial videos on youtube is that by deactivating  a control point (toggle select it and make it appear blue), you are specifying it as the inlet of flow, so the centerline tree will grow from there. If no endpoint is deactivated, then the first point in this fudicial point list will be used as the inlet. However, as in my case the first point is actually ‘F-1’ which is at the top, it did not make sense to grow the tree from there based on the real physiology, so in the end I only kept ‘final_endpoints-15’ as in the inlet, and I can then do some postprocessing to remove C(18) to only keep the centerline curves in the two branches.</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/d/4/d405e984d5e4027ee8cbac930e30233fa49fccaa.png" data-download-href="/uploads/short-url/ufDTdc2ESJcGcQid6eYYm4gtYDM.png?dl=1" title="Screenshot 2024-02-16 at 12.05.12" rel="noopener nofollow ugc"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/d/4/d405e984d5e4027ee8cbac930e30233fa49fccaa_2_345x500.png" alt="Screenshot 2024-02-16 at 12.05.12" data-base62-sha1="ufDTdc2ESJcGcQid6eYYm4gtYDM" width="345" height="500" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/d/4/d405e984d5e4027ee8cbac930e30233fa49fccaa_2_345x500.png, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/d/4/d405e984d5e4027ee8cbac930e30233fa49fccaa_2_517x750.png 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/d/4/d405e984d5e4027ee8cbac930e30233fa49fccaa.png 2x" data-dominant-color="9196C1"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">Screenshot 2024-02-16 at 12.05.12</span><span class="informations">545×788 170 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>

---
