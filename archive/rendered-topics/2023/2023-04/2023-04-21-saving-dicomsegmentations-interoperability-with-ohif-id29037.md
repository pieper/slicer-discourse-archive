---
topic_id: 29037
title: "Saving Dicomsegmentations Interoperability With Ohif"
date: 2023-04-21
url: https://discourse.slicer.org/t/29037
---

# Saving DICOMsegmentations - Interoperability with OHIF

**Topic ID**: 29037
**Date**: 2023-04-21
**URL**: https://discourse.slicer.org/t/saving-dicomsegmentations-interoperability-with-ohif/29037

---

## Post #1 by @ksidis (2023-04-21 07:57 UTC)

<p>I am using 3Dslicer with the Monailabel plugin to run some segmentation models. The result is then exported as DICOMSegmentation and saved to an Orthanc PACS. Up to this point we were using OHIF v2 to visualise the images along with the segmentations. However we have noticed that this is not working for OHIF v3.3. It throws some error about missing SpacingBetweenSlices tag. Anyway, my question is the following do we know whether OHIF v3.3 is capable to read DICOMSegmentations stored using 3DSlicer? Is there a way to tweak the way the segmentations are stored so they will be read by OHIF v3.3?</p>
<p>Thank you.</p>

---

## Post #2 by @pieper (2023-04-23 20:02 UTC)

<p>I saw your <a href="https://github.com/OHIF/Viewers/issues/3335">issue</a> on OHIF github about this.  It would be great if you could provide some example data (no PHI, just phantom or dummy data) to illustrate the issue and we can get to the bottom of this.</p>

---

## Post #3 by @ksidis (2023-04-24 09:41 UTC)

<p>Right after posting this, I had a closer look into the console errors while reading the images with OHIF and tried <a href="https://github.com/OHIF/Viewers/issues/3335" rel="noopener nofollow ugc">this ‚ÄúHail Mary‚Äù solution</a> which worked. For my tests I am using <a href="https://wiki.cancerimagingarchive.net/display/Public/QIN+LUNG+CT#19039647a520d4e15ee04e84bf26ec185e5403b7" rel="noopener nofollow ugc">this</a> open access dataset, the latest version of 3DSlicer for windows and macOS, and the latest stable release of monai label. I hope that helps.</p>

---

## Post #4 by @pieper (2023-04-24 16:30 UTC)

<p>Interesting - thanks for the info.  But are you saying the issue is with the segmentations on TCIA?  I thought you were saying that SEGs from the current version of Slicer weren‚Äôt working.  Can you post an example of the specific file that requires the change in OHIF?</p>

---

## Post #5 by @pieper (2023-04-24 17:34 UTC)

<p>Also <a class="mention" href="/u/ksidis">@ksidis</a> is the SEG generated by MONAI Label or exported from Slicer?</p>

---

## Post #6 by @ksidis (2023-04-25 08:20 UTC)

<p>Apologies for not being clear.</p>
<p>I meant I am simply using open access dicom images and segment them using 3Dslicer with monai label.<br>
The result of the segmentation causes OHIF v3.3 to crash. Please find an example image exported from my pacs <a href="https://drive.google.com/file/d/108VsooMsjAIE1Q-IH_gb3__oj2om4Dyn/view?usp=sharing" rel="noopener nofollow ugc">here</a></p>
<p>My understanding is that monai label simply provides the segmentation mask and 3DSlicer exports that to a DICOMSeg object.</p>

---

## Post #7 by @pieper (2023-04-26 14:56 UTC)

<p>Thanks for sharing this.  I can see with dcmdump that the seg says it‚Äôs made with dcmqi from QIICR:</p>
<pre><code class="lang-auto">(0008,0060) CS [SEG]                                    #   4, 1 Modality
(0008,0070) LO [QIICR]                                  #   6, 1 Manufacturer
</code></pre>
<p>It appears to have valid SpacingBetweenSlices, so it‚Äôs not clear why you needed to patch OHIF.</p>
<pre><code class="lang-auto">      (fffe,e000) na (Item with undefined length #=3)         # u/l, 1 Item
        (0018,0050) DS [5.000000e+00]                           #  12, 1 SliceThickness
        (0018,0088) DS [5.000000e+00]                           #  12, 1 SpacingBetweenSlices
        (0028,0030) DS [6.132812e-01\6.132812e-01]              #  26, 2 PixelSpacing
      (fffe,e00d) na (ItemDelimitationItem)                   #   0, 0 ItemDelimitationItem
</code></pre>
<p>I wonder if it‚Äôs related to this bug: <a href="https://github.com/dcmjs-org/dcmjs/pull/346" class="inline-onebox">Fix: reading sequences with undefined length items - length value of item delimitation tag and new item tag will be used to detect the length of the sequence more precise by kursawero ¬∑ Pull Request #346 ¬∑ dcmjs-org/dcmjs ¬∑ GitHub</a></p>
<p>Would you be able to test OHIF using the latest dcmjs?</p>

---

## Post #8 by @ksidis (2023-04-26 17:56 UTC)

<p>Hey <a class="mention" href="/u/pieper">@pieper</a>, thx for looking into this. Yes I can confirm that the tag is there, so there might be some issue with their DICOM library because the property inside OHIF is null. I‚Äôll try and find some time to test your suggestion.</p>

---

## Post #9 by @pieper (2023-04-26 18:09 UTC)

<p>Thanks for looking into it.  I‚Äôm pretty sure the OHIF v3 code uses dcmjs before that fix was release so there‚Äôs a good chance updating the dependency will work.  Let us know how it goes.</p>

---

## Post #10 by @igoroctaviano (2023-04-28 20:15 UTC)

<p><a class="mention" href="/u/ksidis">@ksidis</a> <a class="mention" href="/u/pieper">@pieper</a> turns out that the problem was not in dcmjs but OHIF.<br>
The logic was getting the tag value from the first image metadata.</p>
<p>I opened a PR to extract it from the SEG‚Äôs shared group seq / pixel measures seq.</p><aside class="onebox githubpullrequest" data-onebox-src="https://github.com/OHIF/Viewers/pull/3344/files">
  <header class="source">

      <a href="https://github.com/OHIF/Viewers/pull/3344/files" target="_blank" rel="noopener nofollow ugc">github.com/OHIF/Viewers</a>
  </header>

  <article class="onebox-body">
    <div class="github-row">



    <div class="github-icon-container" title="Pull Request">
      <svg width="60" height="60" class="github-icon" viewbox="0 0 12 16" aria-hidden="true"><path fill-rule="evenodd" d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
    </div>

  <div class="github-info-container">



      <h4>
        <a href="https://github.com/OHIF/Viewers/pull/3344/files" target="_blank" rel="noopener nofollow ugc">fix: üêõ Missing SpacingBetweenSlices prevents SEG rendering</a>
      </h4>

    <div class="branches">
      <code>OHIF:v3-stable</code> ‚Üê <code>OHIF:fix/issue-3335</code>
    </div>

      <div class="github-info">
        <div class="date">
          opened <span class="discourse-local-date" data-format="ll" data-date="2023-04-28" data-time="20:02:03" data-timezone="UTC">08:02PM - 28 Apr 23 UTC</span>
        </div>

        <div class="user">
          <a href="https://github.com/igoroctaviano" target="_blank" rel="noopener nofollow ugc">
            <img alt="igoroctaviano" src="https://avatars.githubusercontent.com/u/13886933?v=4" class="onebox-avatar-inline" width="20" height="20">
            igoroctaviano
          </a>
        </div>

        <div class="lines" title="1 commits changed 1 files with 13 additions and 4 deletions">
          <a href="https://github.com/OHIF/Viewers/pull/3344/files" target="_blank" rel="noopener nofollow ugc">
            <span class="added">+13</span>
            <span class="removed">-4</span>
          </a>
        </div>
      </div>
  </div>
</div>

  <div class="github-row">
    <p class="github-body-container">Update displaySet metadata parsing logic to extract SpacingBetweenSlices
from S<span class="show-more-container"><a href="https://github.com/OHIF/Viewers/pull/3344" target="_blank" rel="noopener nofollow ugc" class="show-more">‚Ä¶</a></span><span class="excerpt hidden">haredFunctionalGroupsSequence / PixelMeasuresSequence

‚úÖ Closes: https://github.com/OHIF/Viewers/issues/3335</span></p>
  </div>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>


---

## Post #11 by @pieper (2023-04-28 20:24 UTC)

<p>Thanks <a class="mention" href="/u/igoroctaviano">@igoroctaviano</a> !</p>

---
