# Transform Issue in FastModelAlign

**Topic ID**: 32924
**Date**: 2023-11-21
**URL**: https://discourse.slicer.org/t/transform-issue-in-fastmodelalign/32924

---

## Post #1 by @evaherbst (2023-11-21 10:48 UTC)

<p>I am currently testing out FastModelAlign for affine transforms.<br>
I see there are 3 transformation matrices created, I assume in this order:</p>
<ol>
<li>scaling</li>
<li>rigid transformation</li>
<li>affine transformation</li>
</ol>
<p>The resulting model is the result after these 3 transformations and looks as expected.</p>
<p>However, if I make a copy of the original model and apply the “scaling” transform to it, it already matches the FastModelAlign output.</p>
<p>I.e. selecting the “scaling” transform generated by FastModelAlign to a copy of the original model seems to apply the other two transformations (rigid and affine) as well.</p>
<p>Similarly, if I run the registration without the affine transform, applying the “scaling” transform to the original mesh it also translates/rotates it (seems to include rigid transformation too).</p>
<p>I see on the github repo that there is a comment <em>" <span class="hashtag-raw">#Put</span> affine transform node under scaling  transform node, which has been put under the rigid transform node".</em></p>
<p>Does this mean that the scaling transform also contains the information of the affine transform?<br>
The observed behavior would suggest this, but when I look at the actual values of the scaling transform it is just a scaling transform…</p>
<p>I am aware of the LPS/RAS and to/from parent distinctions in the transforms and the exports work well. I am just confused by the behaviour described above within Slicer.</p>
<p>Thank you,<br>
Eva</p>

---

## Post #2 by @muratmaga (2023-11-21 16:00 UTC)

<p><a class="mention" href="/u/evaherbst">@evaherbst</a> transforms are nested, and they are nested in the order they are created. Each one only contains the transformation associated only with that specific step. In this example I am aligning <strong>small</strong> (source) model to a <strong>large</strong> model (target). First there is a linear scaling transform, then a rigid transform and finally an affine transform. Affine transform by itself probably has very little change associated with it because previous steps already taken care of the much larger scaling and alignment transform.</p>
<p>If you want to have a single transform that contains everything, just right-click and harden the transforms nested in the top transform (in this case small_affine). The resultant affine transform will contain everything. The final output (in this case <strong>Model</strong>), has all these transforms applied to the <strong>small</strong> model.</p>
<p><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/7/f/7fffcc13e46b3ccddf0ca720d80b359db784c22a.png" alt="image" data-base62-sha1="igkGgm7gx695VraQ71PAzt7lujM" width="449" height="274"></p>

---

## Post #3 by @evaherbst (2023-11-21 18:27 UTC)

<p>Thank you so much Murat for the quick reply.</p>
<p>I had no idea about the nesting transforms, that makes so much more sense.</p>
<p>The only odd thing is that it seems like the transform at the bottom of my hierarchy (scaling in this case) is containing all of the transforms.</p>
<p>So my hierarchy looks like yours, but if I select “affine”, only affine is applied, but if I select “scaling”, all 3 are applied.</p>
<p>Thanks again,<br>
Eva</p>

---

## Post #4 by @muratmaga (2023-11-21 18:49 UTC)

<aside class="quote no-group" data-username="evaherbst" data-post="3" data-topic="32924">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/evaherbst/48/65595_2.png" class="avatar"> evaherbst:</div>
<blockquote>
<p>So my hierarchy looks like yours, but if I select “affine”, only affine is applied, but if I select “scaling”, all 3 are applied.</p>
</blockquote>
</aside>
<p>I am not sure what you mean by “select affine”, can you clarify? Selecting where?</p>
<p>What the transforms are doing to the model is that affine transform is transforming  the rigid, which in return is transforming the scaling transform. So, if you put your original source model under the scaling transform, all other transforms will be automatically applied in the correct order and you should get the model transformed exactly in the same way as your output model.</p>
<p>Does this help?</p>
<p><div class="lightbox-wrapper"><a class="lightbox" href="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/4/0/40346146cf69365f9195f2612080a2240c2830ab.jpeg" data-download-href="/uploads/short-url/99YMsU20YKHvfA4jdGGdYLdCMnp.jpeg?dl=1" title="image"><img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/4/0/40346146cf69365f9195f2612080a2240c2830ab_2_690x368.jpeg" alt="image" data-base62-sha1="99YMsU20YKHvfA4jdGGdYLdCMnp" width="690" height="368" srcset="https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/4/0/40346146cf69365f9195f2612080a2240c2830ab_2_690x368.jpeg, https://us1.discourse-cdn.com/flex002/uploads/slicer/optimized/3X/4/0/40346146cf69365f9195f2612080a2240c2830ab_2_1035x552.jpeg 1.5x, https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/4/0/40346146cf69365f9195f2612080a2240c2830ab.jpeg 2x" data-dominant-color="D6D3D5"><div class="meta"><svg class="fa d-icon d-icon-far-image svg-icon" aria-hidden="true"><use href="#far-image"></use></svg><span class="filename">image</span><span class="informations">1121×598 101 KB</span><svg class="fa d-icon d-icon-discourse-expand svg-icon" aria-hidden="true"><use href="#discourse-expand"></use></svg></div></a></div></p>

---

## Post #5 by @evaherbst (2023-11-21 18:55 UTC)

<p>Thanks Murat! By select I meant what you did in the subject hierarchy. I should have said “applying the transform”.</p>
<blockquote>
<p>What the transforms are doing to the model is that affine transform is transforming the rigid, which in return is transforming the scaling transform</p>
</blockquote>
<p>Yes, this makes sense now. I was just thinking the affine transform, being the last one applied, would contain all of the ones ^before and so I should apply that in the subject hierarchy. Now it makes sense why the scaling one does all of the transformations.</p>
<p>I was just initially confused because I thought the scaling transform only included scaling, etc. (as it does when you just look at the numbers under “transforms”). But the nesting structure now makes sense.</p>
<p>Thanks for the clarification!<br>
And thanks for developing this tool, it is proving to be very useful already!<br>
Eva</p>

---

## Post #6 by @muratmaga (2023-11-21 19:36 UTC)

<aside class="quote no-group" data-username="evaherbst" data-post="5" data-topic="32924">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/evaherbst/48/65595_2.png" class="avatar"> evaherbst:</div>
<blockquote>
<p>thanks for developing this tool, it is proving to be very useful already!</p>
</blockquote>
</aside>
<p>Glad to hear that! <a class="mention" href="/u/chz31">@chz31</a></p>

---

## Post #7 by @chz31 (2023-11-22 19:53 UTC)

<p>Glad to hear that the module works! We also have some explanation of the nested transformation matrices in the FastModelAlign tutorial at “4. Investigate and Visualize the scaling and rigid transformation process”: <a href="https://github.com/SlicerMorph/Tutorials/tree/main/FastModelAlign" rel="noopener nofollow ugc">https://github.com/SlicerMorph/Tutorials/tree/main/FastModelAlign</a></p>

---

## Post #8 by @evaherbst (2023-11-23 08:37 UTC)

<p>Thanks for sharing the tutorial!<br>
I didn’t see it before.<br>
And thanks again for developing this <img src="https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=12" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>

---

## Post #9 by @evaherbst (2023-11-29 16:17 UTC)

<p>Apologies for one last question.</p>
<p>In an example I made, I am transforming a source mesh to a smaller target mesh.<br>
The scale transform has scale factors of .59, and the source mesh is therefore shrunk to align with the target when the scale transform is applied.<br>
All good so far.</p>
<p>My question is, why is the transform labeled “to parent”? I would think that the source mesh is the parent. But if that is the case, I would expect the “to parent” transform to mean “source to target”, which should be the inverse of .59, rather than .59.</p>
<p>Or is the parent referring to the target rather than the source?</p>
<p>Either way I can of course use this transform and export it (and calculate the inverse if needed). But I was just wondering about the conventions regarding what is considered the parent here.</p>
<p>Thanks!<br>
Eva</p>

---

## Post #10 by @muratmaga (2023-11-29 16:32 UTC)

<p>I do not know the history of terminology and where term parent comes. All i that terms like source, target etc may mean different things in related different fields such computer vision and medical image analysis.</p>

---

## Post #11 by @evaherbst (2023-11-29 16:36 UTC)

<p>Ok, thank you for the quick reply.<br>
I’ll just take it at face value then and not pay attention to the “to parent” labeling but just think of all the transforms as “source to target” within Slicer (with the inverse, so “target to source”, being exported from Slicer)</p>
<p>Best,<br>
Eva</p>

---

## Post #12 by @evaherbst (2023-11-29 16:46 UTC)

<p>Also, I noticed using meshes with relatively low res (about 2k) gave inconsistencies in rigid alignment results when rerunning FastModelAlign with the same settings.<br>
Affine alignments were almost identical.</p>
<p>Just a note for other users to be aware of.</p>

---

## Post #13 by @muratmaga (2023-11-29 17:14 UTC)

<p>Yes, as we showed empirically in the original ALPACA paper (which fastmodelalign is based on), you need 4000-6000 points for optimum registration. If your meshes are sparse in vertices and the generated point clouds are not hitting that limit, you can use the surface toolbox to increase the vertex density.</p>

---

## Post #14 by @evaherbst (2023-11-29 17:17 UTC)

<p>Thanks Murat! Makes sense.</p>

---
