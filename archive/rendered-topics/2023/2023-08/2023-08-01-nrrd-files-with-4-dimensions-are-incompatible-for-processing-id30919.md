# .nrrd files with 4 dimensions are incompatible for processing in other software

**Topic ID**: 30919
**Date**: 2023-08-01
**URL**: https://discourse.slicer.org/t/nrrd-files-with-4-dimensions-are-incompatible-for-processing-in-other-software/30919

---

## Post #1 by @debadrita_jana (2023-08-01 22:01 UTC)

<p>Hello everyone! I use Slicer to process MicroCT scans of fossils of marine microorganisms- so my objectives are probably somewhat different than several of my fellow users. I  faced a n issue with my data processing workflow and will do my best to describe it here.</p>
<p>After reconstruction of the CT Scans using nRecon, I used to save them as .TIFF files, then convert them to .nrrd files using Slicer. After that, I would process the files using a code I wrote in MATLAB, where I would extract the CT number of each voxel and create histograms of the density distribution of each fossil specimen.</p>
<p>Recently, the lab in which I do my scans has recommended that we save the reconstructed images in the .PNG format. I have converted them to .nrrd using Slicer, however,  the files generated by Slicer are not readable by the .nrrdread function in MATLAB. There are several differences that show up in the metadata of the .nrrd’s that I was able to generate earlier vs the newest ones (images below). does anyone have any idea how the files can maintain their compatibility across softwares?</p>
<p>Is there a way  to generate CT numbers using Slicer itself, without having to transfer the files over to MATLAB? I am happy to discuss the code and my workflow in detail with anyone who is interested! Many thanks.<br>
Previous files:<br>
<img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/8/b/8b0d8fc2b18e310f1070973204873108f41cec4f.png" alt="Screenshot 2023-08-01 170000_____" data-base62-sha1="jQ7qhvJ4QTjQ4fLQ3G5GhZiuvx5" width="687" height="311"></p>
<p>New files:<br>
<img src="https://us1.discourse-cdn.com/flex002/uploads/slicer/original/3X/f/9/f99d1837bd85dc3b461776c6838bbcd278135aee.png" alt="Screenshot 2023-08-01 165901" data-base62-sha1="zCbsKJEUfWiDewsmmaSh7QjnINE" width="623" height="312"></p>

---

## Post #2 by @mikebind (2023-08-01 23:48 UTC)

<p>I wonder if the PNG image files are being loaded with 3 color channels, whereas your TIFF files were a single channel. To recover the original CT image values, you would need to know what the transfer function converting CT image values to PNG pixel values was.  If you are lucky, it may just be that the CT voxel value was copied directly into each of the 3 color channels.  If that were the case, then you could just choose any channel and read the value back out.</p>
<p>At a higher level, you can almost certainly do your entire workflow using Slicer without needing to transfer anything to MATLAB. What format is the original data coming off the scanner in?  Slicer doesn’t have any trouble reading DICOM files (which are what come off of medical CT scanners), but I’m not sure what formats are usually used for research MicroCT scanners.  I believe that <a class="mention" href="/u/muratmaga">@muratmaga</a> and the SlicerMorph community here work a lot with research CT scans of non-human skeletal and fossil data, and might be a great resource for you.</p>

---

## Post #3 by @lassoan (2023-08-02 04:11 UTC)

<aside class="quote no-group" data-username="debadrita_jana" data-post="1" data-topic="30919">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/debadrita_jana/48/12327_2.png" class="avatar"> debadrita_jana:</div>
<blockquote>
<p>the files generated by Slicer are not readable by the .nrrdread function in MATLAB</p>
</blockquote>
</aside>
<p>You can use this NRRD reader implementation:</p>
<aside class="onebox githubblob" data-onebox-src="https://github.com/PerkLab/SlicerMatlabBridge/blob/master/MatlabCommander/commandserver/nrrdread.m">
  <header class="source">

      <a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/master/MatlabCommander/commandserver/nrrdread.m" target="_blank" rel="noopener">github.com</a>
  </header>

  <article class="onebox-body">
    <h4><a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/master/MatlabCommander/commandserver/nrrdread.m" target="_blank" rel="noopener">PerkLab/SlicerMatlabBridge/blob/master/MatlabCommander/commandserver/nrrdread.m</a></h4>


      <pre><code class="lang-m">function img = nrrdread(filename)
% Read image and metadata from a NRRD file (see http://teem.sourceforge.net/nrrd/format.html)
%   img = cli_imageread(filename) reads the image volume and associated metadata
%
%   img.pixelData: pixel data array
%   img.ijkToLpsTransform: pixel (IJK) to physical (LPS, assuming 'space' is 'left-posterior-superior')
%     coordinate system transformation, the origin of the IJK coordinate system is (1,1,1) to match Matlab matrix indexing
%   img.metaData: contains all the descriptive information in the image header
%   img.metaDataFieldNames: Contains full names of metadata fields that cannot be used as Matlab field names because they contains
%     special characters (space, dot, etc). Special characters in field names are replaced by underscore by default when the NRRD
%     file is read. Full field names are used when writing the image to NRRD file.
%
%  Supports reading of 3D and 4D volumes.
%
%   Current limitations/caveats:
%   * Block datatype is not supported.
%   * Only tested with "gzip" and "raw" file encodings.
%
% Partly based on the nrrdread.m function with copyright 2012 The MathWorks, Inc.

</code></pre>



  This file has been truncated. <a href="https://github.com/PerkLab/SlicerMatlabBridge/blob/master/MatlabCommander/commandserver/nrrdread.m" target="_blank" rel="noopener">show original</a>

  </article>

  <div class="onebox-metadata">
    
    
  </div>

  <div style="clear: both"></div>
</aside>

<p>I haven’t tested it recently (I stopped using Matlab and switched to Python 5-10 years ago), so maybe the script needs some small changes to use it in latest Matlab versions. But you may also consider switching to Python, because it is just so much more powerful and versatile and you can use Python almost anywhere. You can even run your processing code in Slicer’s embedded Python environment (you can hit using Ctrl-3 to open an interactive Python console where you can access all data that has been loaded into Slicer).</p>

---

## Post #4 by @muratmaga (2023-08-02 10:19 UTC)

<aside class="quote no-group" data-username="debadrita_jana" data-post="1" data-topic="30919">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/debadrita_jana/48/12327_2.png" class="avatar"> debadrita_jana:</div>
<blockquote>
<p>After reconstruction of the CT Scans using nRecon, I used to save them as .TIFF files, then convert them to .nrrd files using Slicer. After that, I would process the files using a code I wrote in MATLAB, where I would extract the CT number of each voxel and create histograms of the density distribution of each fossil specimen.</p>
<p>Recently, the lab in which I do my scans has recommended that we save the reconstructed images in the .PNG format. I have converted them to .nrrd using Slicer, however, the files generated by Slicer are not readable by the .nrrdread function in MATLAB. There are several differences that show up in the metadata of the .nrrd’s that I was able to generate earlier vs the newest ones (images below). does anyone have any idea how the files can maintain their compatibility across softwares?</p>
</blockquote>
</aside>
<p>If you use the SkyscanReconImport from SlicerMorph, you can avoid the multichannel issue and import any format Nrecon provides as output (PNG/BMP/JPG/TIFF). If you want to give it a try, install the SlicerMorph extension, then switch to <strong>SkyScanReconImport</strong> module and simply navigate to the _REC.LOG file outputed by the Nrecon software.</p>

---

## Post #5 by @pieper (2023-08-02 19:31 UTC)

<aside class="quote no-group" data-username="debadrita_jana" data-post="1" data-topic="30919">
<div class="title">
<div class="quote-controls"></div>
<img loading="lazy" alt="" width="24" height="24" src="https://sea2.discourse-cdn.com/flex020/user_avatar/discourse.slicer.org/debadrita_jana/48/12327_2.png" class="avatar"> debadrita_jana:</div>
<blockquote>
<p>Recently, the lab in which I do my scans has recommended that we save the reconstructed images in the .PNG format.</p>
</blockquote>
</aside>
<p>I question the wisdom of this suggestion.  As you can see in your screenshots, the new data is unsigned char (8 bit) while the old files were unsigned short (16 bit).  Since most CT scans have more dynamic range than can fit in 8 bits you are probably losing dynamic range and that can lead to artifacts in your reconstructions.</p>

---
